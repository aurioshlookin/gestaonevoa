<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N√©voa System</title>
    <!-- Favicon SVG Embutido (Fantasma Ciano) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2322d3ee' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M9 10h.01'/><path d='M15 10h.01'/><path d='M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z'/></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map para gerenciar depend√™ncias -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.378.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
        }
    }
    </script>

    <style>
        body {
            background-color: #0f172a; /* slate-900 */
        }
        .mist-title { font-family: 'Cinzel', serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .scroll-custom::-webkit-scrollbar { width: 8px; }
        .scroll-custom::-webkit-scrollbar-track { background: #1e293b; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* Anima√ß√µes simples */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes bounceIn {
            0% { transform: scale(0.1); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    </style>
</head>
<body class="text-slate-200 font-mono">
    <div id="root"></div>

    <!-- Aplica√ß√£o React -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            setDoc, 
            addDoc,
            deleteDoc,
            updateDoc,
            writeBatch,
            query,
            orderBy,
            limit,
            where
        } from "firebase/firestore";
        import { 
            Swords, Shield, Activity, Ghost, Users, UserPlus, Trash2, 
            Save, RefreshCw, AlertCircle, Menu, LogOut, Search, Settings, X, 
            AlertTriangle, Crown, ArrowUp, ArrowDown, ArrowUpDown,
            Heart, Zap, Flame, Droplets, Mountain, Wind, CloudLightning, 
            Cross, Target, Circle, Calendar, Info, Lock, Database, Clock, MessageSquare, Mic, ShieldCheck, UserCog,
            BookOpen, ChevronDown, ChevronUp, FileText, History, Globe
        } from 'lucide-react';

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtpZZaQElw7ieRgXaD3wJ_7EyNwEB9RVo",
            authDomain: "nevoasystem.firebaseapp.com",
            projectId: "nevoasystem",
            storageBucket: "nevoasystem.firebasestorage.app",
            messagingSenderId: "887482895210",
            appId: "1:887482895210:web:1177bbc7fe859d1db37313",
            measurementId: "G-545J0LDVTY"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        const App = () => {
            // CONFIGURA√á√ïES DO DISCORD
            const DISCORD_CLIENT_ID = "1453817939265589452"; 
            const GUILD_ID = "1410456333391761462"; // ID do Servidor da N√©voa
            
            // --- ESTADOS ---
            const [user, setUser] = useState(null); // { id, username, roles: [] }
            const [members, setMembers] = useState([]); 
            const [discordRoster, setDiscordRoster] = useState([]); 
            const [discordRoles, setDiscordRoles] = useState([]); 
            const [auditLogs, setAuditLogs] = useState([]);
            
            // Novos estados para monitoramento
            const [accessLogs, setAccessLogs] = useState([]);
            const [onlineUsers, setOnlineUsers] = useState([]);
            
            // Configura√ß√µes de Mapeamento
            const [roleConfig, setRoleConfig] = useState({}); 
            const [leaderRoleConfig, setLeaderRoleConfig] = useState({}); 
            const [secLeaderRoleConfig, setSecLeaderRoleConfig] = useState({}); 
            
            // Configura√ß√µes de Acesso (Permiss√µes)
            const [accessConfig, setAccessConfig] = useState({
                kamiRoleId: '',
                councilRoleId: '',
                moderatorRoleId: '',
                creatorId: ''
            });

            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [notification, setNotification] = useState(null);
            
            // Estado do Novo Membro
            const [newMember, setNewMember] = useState({ 
                name: '', 
                discordId: '', 
                role: '', 
                specificRoleId: '', 
                ninRole: '', 
                isLeader: false,
                joinDate: new Date().toISOString().split('T')[0]
            });
            
            const [showSettings, setShowSettings] = useState(false); 
            const [settingsTab, setSettingsTab] = useState('roles'); // 'roles' ou 'permissions'
            const [deleteConfirmation, setDeleteConfirmation] = useState(null);
            
            // ESTADOS DE EDI√á√ÉO DE MEMBRO
            const [selectedMember, setSelectedMember] = useState(null); 
            const [editForm, setEditForm] = useState(null); 
            const [isCreating, setIsCreating] = useState(false);

            // Estado para expandir/colapsar detalhes dos cargos
            const [showRoleDetails, setShowRoleDetails] = useState(false);

            const [sortConfig, setSortConfig] = useState({ key: 'rank', direction: 'descending' });
            const [searchTerm, setSearchTerm] = useState("");
            const [isDropdownOpen, setIsDropdownOpen] = useState(false);
            
            // Ref para evitar log duplo
            const hasLoggedAccess = useRef(false);

            // --- CONSTANTES DE RPG ---
            const MASTERIES = [
                { id: 'Fogo', icon: Flame, color: 'text-orange-500' },
                { id: '√Ågua', icon: Droplets, color: 'text-blue-500' },
                { id: 'Terra', icon: Mountain, color: 'text-amber-700' },
                { id: 'Vento', icon: Wind, color: 'text-slate-400' },
                { id: 'Raio', icon: CloudLightning, color: 'text-yellow-400' },
                { id: 'M√©dico', icon: Cross, color: 'text-emerald-400' },
                { id: 'Taijutsu', icon: Activity, color: 'text-red-500' },
                { id: 'Arma', icon: Target, color: 'text-gray-300' },
                { id: 'Bolha', icon: Circle, color: 'text-cyan-300' }
            ];

            const STATS = ['For√ßa', 'Fortitude', 'Intelecto', 'Agilidade', 'Chakra'];

            const Icons = { Swords, Shield, Activity, Ghost, Users, UserPlus, Trash2, Save, RefreshCw, AlertCircle, Menu, LogOut, Lock, Search, Settings, X, Info, AlertTriangle, Crown, ArrowUp, ArrowDown, ArrowUpDown, Heart, Zap, Flame, Droplets, Mountain, Wind, CloudLightning, Cross, Target, Circle, Calendar, Database, Clock, MessageSquare, Mic, ShieldCheck, UserCog, BookOpen, ChevronDown, ChevronUp, FileText, History, Globe };

            const ORG_CONFIG = {
                'sete-laminas': { 
                    id: 'sete-laminas', 
                    name: 'Sete L√¢minas', 
                    icon: 'Swords', 
                    color: 'text-red-400', 
                    bgColor: 'bg-red-900/20', 
                    border: 'border-red-500/30', 
                    limit: 7, 
                    internalRoles: ['Espadachim Iniciante', 'Portador da Espada', 'Mestre das L√¢minas'],
                    roleDetails: [
                        { name: 'Mestre das L√¢minas', desc: 'L√≠der dos espadachins e portador de uma das 7 espadas lend√°rias.' },
                        { name: 'Portador da Espada', desc: 'Membro oficial que possui uma das espadas.' },
                        { name: 'Espadachim Iniciante', desc: 'Aspirante em treinamento.' }
                    ]
                },
                'divisao-especial': { 
                    id: 'divisao-especial', 
                    name: 'Divis√£o Especial (ANBU)', 
                    icon: 'Ghost', 
                    color: 'text-purple-400', 
                    bgColor: 'bg-purple-900/20', 
                    border: 'border-purple-500/30', 
                    limit: 14, 
                    internalRoles: ['Recruta', 'Agente', 'Capit√£o', 'Comandante'],
                    roleDetails: [
                        { name: 'Comandante', desc: 'L√≠der das opera√ß√µes especiais.' },
                        { name: 'Capit√£o', desc: 'L√≠der de esquadr√£o t√°tico.' },
                        { name: 'Agente', desc: 'Operativo de campo plenamente treinado.' },
                        { name: 'Recruta', desc: 'Novo membro em fase de avalia√ß√£o.' }
                    ]
                },
                'forca-policial': { 
                    id: 'forca-policial', 
                    name: 'For√ßa Policial', 
                    icon: 'Shield', 
                    color: 'text-blue-400', 
                    bgColor: 'bg-blue-900/20', 
                    border: 'border-blue-500/30', 
                    limit: 20, 
                    internalRoles: ['Cadete', 'Oficial', 'Sargento', 'Delegado'],
                    roleDetails: [
                        { name: 'Delegado', desc: 'Chefe da for√ßa policial e respons√°vel pela ordem.' },
                        { name: 'Sargento', desc: 'Oficial superior respons√°vel por coordenar patrulhas.' },
                        { name: 'Oficial', desc: 'Policial padr√£o com autoridade de pris√£o.' },
                        { name: 'Cadete', desc: 'Membro em treinamento na academia.' }
                    ]
                },
                'unidade-medica': { 
                    id: 'unidade-medica', 
                    name: 'Unidade M√©dica', 
                    icon: 'Activity', 
                    color: 'text-emerald-400', 
                    bgColor: 'bg-emerald-900/20', 
                    border: 'border-emerald-500/30', 
                    limit: 20, 
                    // Ordem do menor para o maior rank (para ordena√ß√£o correta)
                    internalRoles: [
                        'Estagi√°rio', 
                        'M√©dico de Campo', 
                        'M√©dico J√∫nior', 
                        'M√©dico S√™nior', 
                        'Param√©dico', 
                        'Doutor', 
                        'Residente Chefe', 
                        'Diretor M√©dico'
                    ],
                    roleDetails: [
                        { name: 'Diretor M√©dico', desc: 'L√≠der Supremo da Unidade M√©dica.' },
                        { name: 'Residente Chefe', desc: 'Vice-l√≠der, bra√ßo direito do Diretor.' },
                        { name: 'Doutor', desc: 'M√©dico com fun√ß√µes administrativas e lideran√ßa cl√≠nica.' },
                        { name: 'Param√©dico', desc: 'Elite da Corpora√ß√£o, formam grupos de resposta r√°pida.' },
                        { name: 'M√©dico S√™nior', desc: 'M√©dicos experientes com Chakra, podem ministrar treinamentos.' },
                        { name: 'M√©dico J√∫nior', desc: 'M√©dicos que utilizam Chakra para cura.' },
                        { name: 'M√©dico de Campo', desc: 'M√©dicos focados em primeiros socorros (sem Chakra).' },
                        { name: 'Estagi√°rio', desc: 'Vaga rotativa para aprendizado.' }
                    ]
                }
            };

            // --- SINCRONIZA√á√ÉO ---
            useEffect(() => {
                const unsubMembers = onSnapshot(collection(db, "membros"), (snap) => setMembers(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))), () => setLoading(false));
                const unsubRoster = onSnapshot(doc(db, "server", "roster"), (doc) => { if (doc.exists()) setDiscordRoster(doc.data().users || []); });
                const unsubRoles = onSnapshot(doc(db, "server", "roles"), (doc) => { if (doc.exists()) setDiscordRoles(doc.data().list || []); });
                const unsubConfig = onSnapshot(doc(db, "server", "config"), (doc) => { 
                    if (doc.exists()) {
                        const data = doc.data();
                        setRoleConfig(data.roleMapping || {});
                        setLeaderRoleConfig(data.leaderRoleMapping || {});
                        setSecLeaderRoleConfig(data.secLeaderRoleMapping || {});
                        setAccessConfig(data.accessConfig || { kamiRoleId: '', councilRoleId: '', moderatorRoleId: '', creatorId: '' });
                    }
                });
                return () => { unsubMembers(); unsubRoster(); unsubRoles(); unsubConfig(); };
            }, []);

            // --- SISTEMA DE LOGS E HEARTBEAT (MONITORAMENTO) ---
            useEffect(() => {
                if (!user) {
                    hasLoggedAccess.current = false;
                    return;
                }

                // 1. Log de Entrada (Executa apenas uma vez quando o usu√°rio √© carregado)
                if (!hasLoggedAccess.current) {
                    const logAccess = async () => {
                        try {
                            await addDoc(collection(db, "access_logs"), {
                                userId: user.id,
                                username: user.username || user.displayName,
                                action: 'Acessou o Painel',
                                timestamp: new Date().toISOString()
                            });
                            hasLoggedAccess.current = true;
                        } catch (e) { console.error("Erro ao registrar acesso:", e); }
                    };
                    logAccess();
                }

                // 2. Heartbeat (Status Online) - Executa a cada 60s
                const heartbeat = async () => {
                    try {
                        await setDoc(doc(db, "online_status", user.id), {
                            username: user.username || user.displayName,
                            userId: user.id,
                            avatar: user.avatar,
                            lastSeen: new Date().toISOString()
                        }, { merge: true });
                    } catch (e) { console.error("Heartbeat error:", e); }
                };

                // Executa imediatamente e depois a cada 1 min
                heartbeat();
                const interval = setInterval(heartbeat, 60000);

                return () => clearInterval(interval);
            }, [user]);

            // --- LISTENER DE HIST√ìRICO DE MODIFICA√á√ÉO E ACESSO ---
            // S√≥ ativa se o usu√°rio estiver na aba correta e tiver permiss√£o
            useEffect(() => {
                if (activeTab === 'history') {
                    const q = query(collection(db, "audit_logs"), orderBy("timestamp", "desc"), limit(50));
                    const unsub = onSnapshot(q, (snap) => {
                        setAuditLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                    return () => unsub();
                }
                
                if (activeTab === 'access') {
                    // Logs de Acesso
                    const qLogs = query(collection(db, "access_logs"), orderBy("timestamp", "desc"), limit(50));
                    const unsubLogs = onSnapshot(qLogs, (snap) => {
                        setAccessLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                    // Usu√°rios Online (Heartbeat)
                    const qOnline = collection(db, "online_status");
                    const unsubOnline = onSnapshot(qOnline, (snap) => {
                        const now = new Date();
                        const activeUsers = snap.docs
                            .map(doc => doc.data())
                            .filter(u => {
                                if(!u.lastSeen) return false;
                                const diff = (now - new Date(u.lastSeen)) / 1000 / 60; // diff em minutos
                                return diff <= 5; // Considera online se visto nos √∫ltimos 5 min
                            });
                        setOnlineUsers(activeUsers);
                    });

                    return () => { unsubLogs(); unsubOnline(); };
                }
            }, [activeTab]);

            // --- SISTEMA DE LOGS (MODIFICA√á√ïES) ---
            const logAction = async (action, target, details, org = null) => {
                if (!user) return;
                try {
                    await addDoc(collection(db, "audit_logs"), {
                        action,
                        target,
                        details,
                        executor: user.username || user.displayName,
                        executorId: user.id,
                        org: org || 'Sistema',
                        timestamp: new Date().toISOString()
                    });
                } catch (e) { console.error("Erro ao gerar log:", e); }
            };

            // --- SISTEMA DE PERMISS√ïES ---
            const checkPermission = (action, contextOrgId = null) => {
                if (!user) return false;
                
                // 1. Criador (Acesso Total Absoluto)
                if (user.id === accessConfig.creatorId) return true;

                const userRoles = user.roles || [];

                // 2. Admins Globais (Kami e Conselho)
                if (userRoles.includes(accessConfig.kamiRoleId) || userRoles.includes(accessConfig.councilRoleId)) {
                    return true;
                }

                // 3. Configura√ß√µes do Sistema (S√≥ Admins Globais/Criador)
                if (action === 'MANAGE_SETTINGS') return false;

                // 4. Edi√ß√£o de Membros (L√≠deres)
                if (action === 'EDIT_MEMBER' || action === 'ADD_MEMBER' || action === 'DELETE_MEMBER') {
                    // Se for moderador ou membro comum, bloqueia edi√ß√£o global
                    if (userRoles.includes(accessConfig.moderatorRoleId)) return false;

                    // Se for L√≠der, verifica se √© l√≠der DAQUELA organiza√ß√£o
                    if (contextOrgId) {
                        const leaderRoleId = leaderRoleConfig[contextOrgId];
                        if (leaderRoleId && userRoles.includes(leaderRoleId)) {
                            return true;
                        }
                    }
                }

                return false;
            };

            // Helper para verificar se pode ver os bot√µes de a√ß√£o
            const canManageOrg = (orgId) => checkPermission('EDIT_MEMBER', orgId);
            const canManageSettings = checkPermission('MANAGE_SETTINGS');

            // --- PERMISS√ÉO PARA VER HIST√ìRICO & ACESSOS ---
            const canViewHistory = useMemo(() => {
                if (!user) return false;
                if (user.id === accessConfig.creatorId) return true;
                const userRoles = user.roles || [];
                
                // Globais
                if (userRoles.includes(accessConfig.kamiRoleId) || 
                    userRoles.includes(accessConfig.councilRoleId) || 
                    userRoles.includes(accessConfig.moderatorRoleId)) return true;
                
                // L√≠deres de qualquer org
                const isLeader = Object.values(leaderRoleConfig).some(roleId => userRoles.includes(roleId));
                return isLeader;
            }, [user, accessConfig, leaderRoleConfig]);

            // --- VERIFICA√á√ÉO DE ACESSO AO PAINEL (LOGIN GATE) ---
            const canAccessPanel = useMemo(() => {
                if (!user) return false;
                if (user.id === accessConfig.creatorId) return true; // Creator always access

                const userRoles = user.roles || [];
                
                // Coleta todos os IDs de cargos configurados no sistema (incluindo membros simples)
                const allowedRoles = new Set();
                
                // 1. Cargos de Acesso Global
                if (accessConfig.kamiRoleId) allowedRoles.add(accessConfig.kamiRoleId);
                if (accessConfig.councilRoleId) allowedRoles.add(accessConfig.councilRoleId);
                if (accessConfig.moderatorRoleId) allowedRoles.add(accessConfig.moderatorRoleId);
                
                // 2. Cargos de Organiza√ß√£o (L√≠deres, Secund√°rios e Membros Comuns)
                Object.values(roleConfig).forEach(id => { if(id) allowedRoles.add(id); });
                Object.values(leaderRoleConfig).forEach(id => { if(id) allowedRoles.add(id); });
                Object.values(secLeaderRoleConfig).forEach(id => { if(id) allowedRoles.add(id); });

                // Verifica se o usu√°rio tem ALGUM desses cargos configurados
                return userRoles.some(roleId => allowedRoles.has(roleId));
            }, [user, accessConfig, roleConfig, leaderRoleConfig, secLeaderRoleConfig]);

            // --- L√ìGICA DE RPG (C√ÅLCULOS) ---
            const calculateMaxPoints = (level) => {
                if (level <= 1) return 0; 
                let points = 0;
                const levelsTo50 = Math.min(level, 50) - 1;
                points += levelsTo50 * 5;
                if (level > 50) {
                    points += (level - 50) * 4;
                }
                return points;
            };

            const calculateStats = (baseStats, hasBonus) => {
                const stats = { ...baseStats };
                const bonusMultiplier = hasBonus ? 1.10 : 1;
                
                let calculated = {};
                STATS.forEach(key => {
                    calculated[key] = Math.floor(stats[key] * bonusMultiplier);
                });

                const fortitudeExtra = Math.max(0, calculated['Fortitude'] - 5);
                const hp = 250 + (fortitudeExtra * 8);

                const chakraExtra = Math.max(0, calculated['Chakra'] - 5);
                const cp = 50 + (chakraExtra * 5);

                return { ...calculated, hp, cp };
            };

            // --- L√ìGICA DE ATIVIDADE (RESTAURADA: SCORE & TIERS + DETALHES + FALLBACK) ---
            const getActivityStats = (member) => {
                const activityMap = member.activityStats || {};
                const msgMap = member.dailyMessages || {};
                const voiceMap = member.dailyVoice || {};

                let totalScore = 0;
                let totalMsgs = 0;
                let totalVoiceMins = 0;

                const today = new Date();
                for (let i = 0; i < 14; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    
                    totalScore += (activityMap[dateStr] || 0);
                    totalMsgs += (msgMap[dateStr] || 0);
                    totalVoiceMins += (voiceMap[dateStr] || 0);
                }

                if (totalMsgs === 0 && totalVoiceMins === 0 && totalScore > 0) {
                    totalMsgs = totalScore; 
                }

                let tier = 'Fantasma', color = 'bg-red-500', icon = 'üëª', width = '5%';
                if (totalScore > 250) { tier = 'Lend√°rio'; color = 'bg-purple-500'; icon = 'üëë'; width = '100%'; }
                else if (totalScore > 50) { tier = 'Ativo'; color = 'bg-emerald-500'; icon = 'üî•'; width = '75%'; }
                else if (totalScore > 10) { tier = 'Regular'; color = 'bg-blue-500'; icon = 'üòê'; width = '50%'; }
                else if (totalScore > 0) { tier = 'Adormecido'; color = 'bg-yellow-500'; icon = 'üí§'; width = '25%'; }
                
                const voiceHours = Math.floor(totalVoiceMins / 60);
                const voiceRemMins = totalVoiceMins % 60;
                const voiceString = `${voiceHours}h ${voiceRemMins}m`;

                return { 
                    total: totalScore, 
                    tier, color, icon, width,
                    details: { msgs: totalMsgs, voice: voiceString }
                };
            };

            // --- A√á√ïES DO SISTEMA ---
            const openCreateModal = () => {
                setIsCreating(true);
                setSearchTerm("");
                const orgId = activeTab;
                const defaultRole = ORG_CONFIG[orgId].internalRoles[0];
                setEditForm({
                    name: '', discordId: '', org: orgId, ninRole: defaultRole, specificRoleId: '', isLeader: false,
                    level: 1, guildBonus: false, masteries: [],
                    stats: { For√ßa: 5, Fortitude: 5, Intelecto: 5, Agilidade: 5, Chakra: 5 },
                    joinDate: new Date().toISOString().split('T')[0]
                });
                setSelectedMember({ org: orgId });
            };

            const handleAddMember = async (orgId) => {
                if (!checkPermission('ADD_MEMBER', orgId)) return showNotification('Sem permiss√£o para adicionar nesta org.', 'error');
                if (!newMember.name || !newMember.discordId || !newMember.ninRole) return showNotification('Preencha os campos obrigat√≥rios!', 'error');
                
                const currentCount = members.filter(m => m.org === orgId).length;
                if (currentCount >= ORG_CONFIG[orgId].limit) return showNotification('Limite atingido!', 'error');

                let finalRoleId = newMember.specificRoleId || roleConfig[orgId];
                let finalRoleName = newMember.role;
                if (!newMember.specificRoleId && finalRoleId) {
                    const r = discordRoles.find(role => role.id === finalRoleId);
                    finalRoleName = r ? r.name : "Membro";
                }

                if (newMember.isLeader) {
                    const currentLeader = members.find(m => m.org === orgId && m.isLeader === true);
                    if (currentLeader) {
                        let newRoleForOldLeader = currentLeader.ninRole;
                        if (orgId === 'unidade-medica' && currentLeader.ninRole === 'Diretor M√©dico') newRoleForOldLeader = 'Residente Chefe';
                        await updateDoc(doc(db, "membros", currentLeader.id), { isLeader: false, ninRole: newRoleForOldLeader });
                    }
                }

                const docId = `${newMember.discordId}_${orgId}`;
                let finalNinRole = newMember.ninRole;
                if (newMember.isLeader && orgId === 'unidade-medica') finalNinRole = 'Diretor M√©dico';

                const memberData = { 
                    name: newMember.name, discordId: newMember.discordId, org: orgId, role: finalRoleName, 
                    specificRoleId: finalRoleId, ninRole: finalNinRole, isLeader: newMember.isLeader, joinDate: newMember.joinDate,
                    level: 1, guildBonus: false, masteries: [], stats: { For√ßa: 5, Fortitude: 5, Intelecto: 5, Agilidade: 5, Chakra: 5 },
                    activityStats: {}, status: 'Ativo', updatedAt: new Date().toISOString()
                };

                try {
                    await setDoc(doc(db, "membros", docId), memberData);
                    logAction("Adicionar Membro", newMember.name, `Adicionado em ${ORG_CONFIG[orgId].name} como ${finalNinRole}`, orgId);
                    setNewMember({ name: '', discordId: '', ninRole: '', isLeader: false, specificRoleId: '', joinDate: new Date().toISOString().split('T')[0] });
                    setSearchTerm("");
                    showNotification('Salvo!', 'success');
                } catch (e) { showNotification('Erro: ' + e.message, 'error'); }
            };

            const handleRemoveMember = async (id) => {
                if(!deleteConfirmation) return;
                if (!checkPermission('DELETE_MEMBER', activeTab)) return showNotification('Sem permiss√£o para remover.', 'error');
                try {
                    const memberToRemove = members.find(m => m.id === deleteConfirmation);
                    await deleteDoc(doc(db, "membros", String(deleteConfirmation)));
                    logAction("Remover Membro", memberToRemove ? memberToRemove.name : "Desconhecido", "Removido do painel", activeTab);
                    showNotification('Removido com sucesso.', 'success');
                    setDeleteConfirmation(null);
                } catch (e) { alert(`Erro t√©cnico: ${e.message}`); setDeleteConfirmation(null); }
            };

            const handleSaveConfig = async () => {
                if (!canManageSettings) return showNotification('Apenas Admins podem alterar configura√ß√µes.', 'error');
                try {
                    await setDoc(doc(db, "server", "config"), { 
                        roleMapping: roleConfig, 
                        leaderRoleMapping: leaderRoleConfig, 
                        secLeaderRoleMapping: secLeaderRoleConfig,
                        accessConfig: accessConfig // Salva permiss√µes tamb√©m
                    }, { merge: true });
                    logAction("Configura√ß√µes", "Sistema", "Cargos e Permiss√µes atualizados");
                    showNotification('Configura√ß√µes Salvas!', 'success');
                    setShowSettings(false);
                } catch (e) { showNotification('Erro ao salvar.', 'error'); }
            };

            const openEditModal = (member) => {
                const defaultStats = { For√ßa: 5, Fortitude: 5, Intelecto: 5, Agilidade: 5, Chakra: 5 };
                setEditForm({
                    ...member,
                    level: member.level || 1,
                    guildBonus: member.guildBonus || false,
                    masteries: member.masteries || [],
                    stats: member.stats || defaultStats,
                    joinDate: member.joinDate || new Date().toISOString().split('T')[0]
                });
                setSelectedMember(member);
            };

            const handleSaveEdit = async () => {
                if (!selectedMember || !editForm) return;
                const orgId = isCreating ? activeTab : selectedMember.org;
                if (!checkPermission('EDIT_MEMBER', orgId)) return showNotification('Sem permiss√£o para editar nesta org.', 'error');

                // (Mesma l√≥gica de AddMember para leaders e roles...)
                let finalRoleId = editForm.specificRoleId || roleConfig[orgId];
                let finalRoleName = "Membro";
                if (finalRoleId) {
                    const r = discordRoles.find(role => role.id === finalRoleId);
                    if (r) finalRoleName = r.name;
                }

                if (editForm.isLeader) {
                    const currentLeader = members.find(m => m.org === orgId && m.isLeader === true && m.discordId !== editForm.discordId);
                    if (currentLeader) {
                        let newRoleForOldLeader = currentLeader.ninRole;
                        if (orgId === 'unidade-medica' && currentLeader.ninRole === 'Diretor M√©dico') newRoleForOldLeader = 'Residente Chefe';
                        await updateDoc(doc(db, "membros", currentLeader.id), { isLeader: false, ninRole: newRoleForOldLeader });
                    }
                    if (orgId === 'unidade-medica') editForm.ninRole = 'Diretor M√©dico';
                }

                const docId = isCreating ? `${editForm.discordId}_${orgId}` : selectedMember.id;
                const payload = {
                    ...editForm, org: orgId, role: finalRoleName, specificRoleId: finalRoleId,
                    status: 'Ativo', updatedAt: new Date().toISOString(), statsUpdatedAt: new Date().toISOString()
                };

                try {
                    if (isCreating) await setDoc(doc(db, "membros", docId), payload);
                    else await updateDoc(doc(db, "membros", docId), payload);
                    
                    const actionName = isCreating ? "Adicionar Membro" : "Editar Membro";
                    logAction(actionName, editForm.name, `Level: ${editForm.level}, Rank: ${editForm.ninRole}`, orgId);

                    showNotification('Salvo com sucesso!', 'success');
                    setSelectedMember(null); setEditForm(null);
                } catch (e) { showNotification('Erro: ' + e.message, 'error'); }
            };

            const toggleMastery = (masteryId) => {
                const current = editForm.masteries || [];
                if (current.includes(masteryId)) setEditForm({...editForm, masteries: current.filter(m => m !== masteryId)});
                else setEditForm({...editForm, masteries: [...current, masteryId]});
            };

            const updateStat = (stat, value) => {
                const val = Math.max(0, parseInt(value) || 0); 
                const newStats = { ...editForm.stats, [stat]: val };
                setEditForm({ ...editForm, stats: newStats });
            };

            const handleToggleLeader = async (member) => {
                if (!checkPermission('EDIT_MEMBER', member.org)) return showNotification('Sem permiss√£o.', 'error');
                // (L√≥gica de toggle igual)
                try {
                    const orgId = member.org;
                    const newStatus = !member.isLeader;
                    let actionDetail = "";

                    if (newStatus === true) {
                        const currentLeader = members.find(m => m.org === orgId && m.isLeader === true);
                        if (currentLeader && currentLeader.id !== member.id) {
                            let newRoleForOldLeader = currentLeader.ninRole;
                            if (orgId === 'unidade-medica' && currentLeader.ninRole === 'Diretor M√©dico') newRoleForOldLeader = 'Residente Chefe';
                            await updateDoc(doc(db, "membros", currentLeader.id), { isLeader: false, ninRole: newRoleForOldLeader });
                        }
                        let newRoleForNewLeader = member.ninRole;
                        if (orgId === 'unidade-medica') newRoleForNewLeader = 'Diretor M√©dico';
                        await updateDoc(doc(db, "membros", member.id), { isLeader: true, ninRole: newRoleForNewLeader });
                        actionDetail = "Promovido a L√≠der";
                    } else { 
                        await updateDoc(doc(db, "membros", member.id), { isLeader: false }); 
                        actionDetail = "Removido da Lideran√ßa";
                    }
                    
                    logAction("Alterar Lideran√ßa", member.name, actionDetail, orgId);
                    showNotification('Lideran√ßa alterada.', 'success');
                } catch (e) { showNotification('Erro ao alterar.', 'error'); }
            };

            const handleSelectUser = (user) => {
                setEditForm({ ...editForm, name: user.displayName || user.username, discordId: user.id });
                setSearchTerm(user.displayName || user.username);
                setIsDropdownOpen(false);
            };

            const maxPoints = editForm ? calculateMaxPoints(editForm.level) : 0;
            const usedPoints = editForm ? STATS.reduce((acc, stat) => acc + (editForm.stats[stat] - 5), 0) : 0;
            const remainingPoints = maxPoints - usedPoints;
            const finalVitals = editForm ? calculateStats(editForm.stats, editForm.guildBonus) : { hp: 250, cp: 50 };

            const filteredRoster = discordRoster.filter(u => (u.displayName || u.username).toLowerCase().includes(searchTerm.toLowerCase()));
            
            // --- AUTH CORRIGIDA COM SCOPE E PERSIST√äNCIA ---
            const handleLogin = () => { 
                const currentPath = window.location.origin + window.location.pathname;
                const redirectUri = encodeURIComponent(currentPath);
                window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=identify%20guilds.members.read`; 
            };

            // L√ìGICA DE PERSIST√äNCIA E LOGIN
            useEffect(() => { 
                const f = new URLSearchParams(window.location.hash.slice(1)); 
                let accessToken = f.get('access_token');

                if (!accessToken) {
                    accessToken = localStorage.getItem('discord_access_token');
                } else {
                    localStorage.setItem('discord_access_token', accessToken);
                    window.history.pushState({}, document.title, window.location.pathname);
                }

                if (accessToken) { 
                    setLoading(true);
                    fetch('https://discord.com/api/users/@me', {headers:{Authorization:`Bearer ${accessToken}`}})
                    .then(r => {
                        if (!r.ok) throw new Error("Token inv√°lido");
                        return r.json();
                    })
                    .then(userData => {
                        fetch(`https://discord.com/api/users/@me/guilds/${GUILD_ID}/member`, {headers:{Authorization:`Bearer ${accessToken}`}})
                        .then(r => r.ok ? r.json() : { roles: [] }) 
                        .then(memberData => {
                            setUser({ ...userData, roles: memberData.roles || [] });
                            setLoading(false);
                        });
                    })
                    .catch(err => {
                        console.error("Sess√£o expirada:", err);
                        localStorage.removeItem('discord_access_token'); 
                        setUser(null);
                        setLoading(false);
                    });
                } else {
                    setLoading(false);
                }
            }, []);
            
            const showNotification = (msg, type) => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };

            const getRoleRank = (member) => { const roles = ORG_CONFIG[member.org]?.internalRoles || []; return roles.indexOf(member.ninRole); };
            const getMemberOrgsInfo = (discordId) => {
                const userOrgs = members.filter(m => m.discordId === discordId);
                if (userOrgs.length <= 1) return null;
                const orgNames = userOrgs.map(m => ORG_CONFIG[m.org]?.name || m.org).join(", ");
                return { count: userOrgs.length, names: orgNames };
            };
            const getMultiOrgMembers = () => {
                const memberMap = {};
                members.forEach(m => {
                    if (!memberMap[m.discordId]) memberMap[m.discordId] = { name: m.name, orgs: [] };
                    const orgName = ORG_CONFIG[m.org]?.name || m.org;
                    if (!memberMap[m.discordId].orgs.includes(orgName)) memberMap[m.discordId].orgs.push(orgName);
                });
                return Object.values(memberMap).filter(u => u.orgs.length > 1);
            };
            const multiOrgUsers = getMultiOrgMembers();
            const formatDateTime = (isoString) => { if (!isoString) return "Nunca"; const date = new Date(isoString); return `${date.toLocaleDateString('pt-BR')} √†s ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`; };

            const requestSort = (key) => setSortConfig({ key, direction: sortConfig.key === key && sortConfig.direction === 'ascending' ? 'descending' : 'ascending' });
            const getSortedMembers = (list) => {
                return [...list].sort((a, b) => {
                    if (sortConfig.key === 'rank' || sortConfig.key === 'ninRole') {
                        const rankA = getRoleRank(a); const rankB = getRoleRank(b);
                        if (rankA !== rankB) return sortConfig.direction === 'ascending' ? rankA - rankB : rankB - rankA;
                        const dateA = new Date(a.joinDate || '9999-12-31').getTime(); const dateB = new Date(b.joinDate || '9999-12-31').getTime();
                        if (dateA !== dateB) return dateA - dateB;
                        const leaderA = a.isLeader ? 1 : 0; const leaderB = b.isLeader ? 1 : 0; return leaderB - leaderA; 
                    }
                    if (sortConfig.key === 'activity') {
                        const actA = getActivityStats(a).total; const actB = getActivityStats(b).total;
                        return sortConfig.direction === 'ascending' ? actA - actB : actB - actA;
                    }
                    let av = a[sortConfig.key], bv = b[sortConfig.key];
                    if (sortConfig.key === 'joinDate') {
                        const dateA = new Date(av || '1970-01-01'); const dateB = new Date(bv || '1970-01-01');
                        return sortConfig.direction === 'ascending' ? dateA - dateB : dateB - dateA;
                    }
                    if (typeof av === 'boolean') { av = av?1:0; bv = bv?1:0; }
                    else if (typeof av === 'string') { av = av.toLowerCase(); bv = bv.toLowerCase(); }
                    if (av === undefined || av === null) av = ''; if (bv === undefined || bv === null) bv = '';
                    return av < bv ? (sortConfig.direction === 'ascending' ? -1 : 1) : (sortConfig.direction === 'ascending' ? 1 : -1);
                });
            };
            const SortIcon = ({k}) => sortConfig.key !== k ? <ArrowUpDown size={14} className="opacity-30 ml-1"/> : (sortConfig.direction === 'ascending' ? <ArrowUp size={14} className="text-cyan-400"/> : <ArrowDown size={14} className="text-cyan-400"/>);
            const formatDate = (dateString) => { if (!dateString) return "-"; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; };

            if (!user) return (
                <div className="min-h-screen bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] flex items-center justify-center p-4 font-mono">
                    <div className="max-w-md w-full bg-slate-800/80 backdrop-blur border border-slate-700 p-8 rounded-2xl text-center shadow-2xl">
                        <Ghost size={48} className="mx-auto text-cyan-400 mb-6" />
                        <h1 className="text-3xl font-bold text-white mb-2" style={{ fontFamily: 'Cinzel, serif' }}>N√©voa System</h1>
                        <button onClick={handleLogin} className="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-3 rounded mb-4">Entrar com Discord</button>
                    </div>
                </div>
            );

            // TELA DE ACESSO NEGADO
            if (!canAccessPanel) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-mono">
                    <div className="max-w-md w-full bg-slate-800 border border-red-500/30 p-8 rounded-2xl text-center shadow-2xl">
                        <ShieldCheck size={48} className="mx-auto text-red-500 mb-6" />
                        <h1 className="text-2xl font-bold text-white mb-2">Acesso Negado</h1>
                        <p className="text-slate-400 mb-6">Voc√™ n√£o possui permiss√£o para acessar este painel. Certifique-se de possuir um dos cargos configurados no sistema ou entre em contato com um administrador.</p>
                        <button onClick={() => { localStorage.removeItem('discord_access_token'); setUser(null); }} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded transition-colors">Voltar / Logout</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] text-slate-200 font-mono">
                    {/* MODAL DE EDI√á√ÉO/CRIA√á√ÉO */}
                    {selectedMember && editForm && (
                        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-4xl shadow-2xl animate-fade-in flex flex-col max-h-[95vh]">
                                <div className="p-6 border-b border-slate-700 flex justify-between items-start bg-slate-900/50 rounded-t-xl">
                                    <div>
                                        <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                            {isCreating ? "Novo Membro" : editForm.name}
                                            {editForm.isLeader && <Crown size={20} className="text-yellow-400" />}
                                        </h2>
                                        <p className="text-slate-400 text-sm font-mono">{isCreating ? `Adicionando √† ${ORG_CONFIG[selectedMember.org].name}` : `Ninja da ${ORG_CONFIG[selectedMember.org].name}`}</p>
                                    </div>
                                    <button onClick={() => setSelectedMember(null)} className="text-slate-400 hover:text-white"><X size={24} /></button>
                                </div>

                                <div className="p-6 overflow-y-auto scroll-custom grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        {isCreating && (
                                            <div className="bg-cyan-900/20 p-4 rounded-lg border border-cyan-500/30">
                                                <label className="text-sm font-bold text-cyan-400 mb-2 block">Selecionar Usu√°rio do Discord</label>
                                                <div className="relative">
                                                    <input type="text" placeholder="Digite para buscar..." className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-cyan-500 outline-none" value={searchTerm} onChange={(e) => { setSearchTerm(e.target.value); setIsDropdownOpen(true); }} onFocus={() => setIsDropdownOpen(true)} />
                                                    {isDropdownOpen && (
                                                        <>
                                                            <div className="fixed inset-0 z-10" onClick={() => setIsDropdownOpen(false)}></div>
                                                            <div className="absolute z-20 w-full bg-slate-900 border border-slate-600 rounded-b-lg shadow-xl max-h-40 overflow-y-auto mt-1 scroll-custom">
                                                                {filteredRoster.map(u => (
                                                                    <div key={u.id} className="p-2 hover:bg-slate-800 cursor-pointer text-sm text-white" onClick={() => handleSelectUser(u)}>{u.displayName || u.username} <span className="text-slate-500 text-xs">(@{u.username})</span></div>
                                                                ))}
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                                {editForm.name && <p className="text-xs text-emerald-400 mt-2">Selecionado: {editForm.name}</p>}
                                            </div>
                                        )}
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between flex-wrap gap-4">
                                            <div className="flex items-center gap-4">
                                                <label className="text-sm font-bold text-cyan-400">N√≠vel:</label>
                                                <input type="number" min="1" max="60" className="bg-slate-800 border border-slate-600 rounded w-16 p-1 text-center text-white font-bold" value={editForm.level} onChange={(e) => setEditForm({...editForm, level: e.target.value})} />
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <Calendar size={16} className="text-slate-400" />
                                                <input type="date" className="bg-slate-800 border border-slate-600 rounded p-1 text-white text-xs" value={editForm.joinDate || ""} onChange={(e) => setEditForm({...editForm, joinDate: e.target.value})} />
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <label className="text-sm text-slate-300 cursor-pointer select-none" htmlFor="bonusToggle">B√¥nus (10%)</label>
                                                <div onClick={() => setEditForm({...editForm, guildBonus: !editForm.guildBonus})} className={`w-12 h-6 rounded-full p-1 cursor-pointer transition-colors ${editForm.guildBonus ? 'bg-cyan-600' : 'bg-slate-700'}`}>
                                                    <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${editForm.guildBonus ? 'translate-x-6' : ''}`}></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="text-white font-bold flex items-center gap-2"><Activity size={16}/> Atributos</h3>
                                                    {!isCreating && selectedMember.statsUpdatedAt && (<p className="text-[10px] text-slate-500 mt-1 flex items-center gap-1"><Clock size={10} /> Atualizado em: {formatDateTime(selectedMember.statsUpdatedAt)}</p>)}
                                                </div>
                                                <span className={`text-xs font-bold px-2 py-1 rounded ${remainingPoints < 0 ? 'bg-red-900/50 text-red-400' : 'bg-slate-800 text-slate-400'}`}>Pontos: {remainingPoints} / {maxPoints}</span>
                                            </div>
                                            <div className="space-y-3">
                                                {STATS.map(stat => (
                                                    <div key={stat} className="flex items-center justify-between">
                                                        <label className="text-sm text-slate-300 w-24">{stat}</label>
                                                        <div className="flex items-center gap-2">
                                                            <input type="number" min="5" className="bg-slate-800 border border-slate-600 rounded w-20 p-1 text-center text-cyan-400 font-bold font-mono outline-none focus:border-cyan-500" value={editForm.stats[stat]} onChange={(e) => updateStat(stat, e.target.value)} />
                                                        </div>
                                                        {editForm.guildBonus && <span className="text-xs text-emerald-400 font-mono w-8 text-right">({Math.floor(editForm.stats[stat] * 1.1)})</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-red-900/20 border border-red-500/30 p-4 rounded-lg text-center"><Heart className="mx-auto text-red-500 mb-2" /><span className="text-2xl font-bold text-white">{finalVitals.hp}</span><p className="text-xs text-red-400 uppercase mt-1">Vida (HP)</p></div>
                                            <div className="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg text-center"><Zap className="mx-auto text-blue-500 mb-2" /><span className="text-2xl font-bold text-white">{finalVitals.cp}</span><p className="text-xs text-blue-400 uppercase mt-1">Chakra (CP)</p></div>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                            <h3 className="text-white font-bold mb-3">Cargos & Fun√ß√£o</h3>
                                            <div className="mb-4">
                                                <label className="text-xs text-slate-400 mb-1 block">Cargo Nin Online</label>
                                                <select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none" value={editForm.ninRole} onChange={(e) => setEditForm({...editForm, ninRole: e.target.value})}>
                                                    {ORG_CONFIG[selectedMember.org].internalRoles.map(r => <option key={r} value={r}>{r}</option>)}
                                                </select>
                                            </div>
                                            <div className="mb-4">
                                                <label className="text-xs text-slate-400 mb-1 block">Cargo Espec√≠fico Discord (Opcional)</label>
                                                <select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none text-sm" value={editForm.specificRoleId || ""} onChange={(e) => setEditForm({...editForm, specificRoleId: e.target.value})}>
                                                    <option value="">Padr√£o da Organiza√ß√£o</option>
                                                    {discordRoles.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-3 bg-slate-800 p-3 rounded border border-slate-600">
                                                <input type="checkbox" id="leaderCheck" checked={editForm.isLeader} onChange={(e) => setEditForm({...editForm, isLeader: e.target.checked})} className="w-4 h-4 text-cyan-600 rounded bg-gray-700 border-gray-600"/>
                                                <label htmlFor="leaderCheck" className="text-sm text-white font-bold cursor-pointer select-none flex items-center gap-2"><Crown size={14} className={editForm.isLeader ? "text-yellow-400" : "text-slate-500"}/> L√≠der da Organiza√ß√£o?</label>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700 h-full">
                                            <h3 className="text-white font-bold mb-4">Maestrias</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                {MASTERIES.map(m => {
                                                    const isActive = editForm.masteries.includes(m.id);
                                                    return (<div key={m.id} onClick={() => toggleMastery(m.id)} className={`cursor-pointer p-3 rounded border flex items-center gap-3 transition-all ${isActive ? 'bg-slate-700 border-cyan-500/50' : 'bg-slate-800 border-slate-700 hover:bg-slate-700/50'}`}><div className={`${isActive ? 'text-white' : m.color}`}>{React.createElement(m.icon, {size: 18})}</div><span className={`text-sm ${isActive ? 'text-white font-bold' : 'text-slate-400'}`}>{m.id}</span></div>);
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="p-6 border-t border-slate-700 bg-slate-900/50 rounded-b-xl flex justify-between items-center">
                                    <span className="text-xs text-slate-500">{remainingPoints < 0 ? "‚ö†Ô∏è Pontos excedidos!" : "Distribui√ß√£o v√°lida."}</span>
                                    <div className="flex gap-3">
                                        <button onClick={() => setSelectedMember(null)} className="px-6 py-2 text-slate-400 hover:text-white transition-colors">Cancelar</button>
                                        {/* S√≥ mostra salvar se tiver permiss√£o */}
                                        {canManageOrg(selectedMember.org) && (
                                            <button onClick={handleSaveEdit} className="bg-cyan-600 hover:bg-cyan-500 text-white px-8 py-2 rounded font-bold shadow-lg shadow-cyan-500/20">{isCreating ? "Adicionar Membro" : "Salvar Altera√ß√µes"}</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Exclus√£o */}
                    {deleteConfirmation && (
                        <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-600 rounded-xl p-6 max-w-md w-full shadow-2xl animate-fade-in text-center">
                                <AlertTriangle className="mx-auto text-yellow-400 mb-4" size={48} />
                                <h3 className="text-xl font-bold text-white mb-2">Confirmar Exclus√£o</h3>
                                <p className="text-slate-400 text-sm mb-6">Tem certeza? Isso remover√° o registro e os cargos.</p>
                                <div className="flex justify-center gap-3">
                                    <button onClick={() => setDeleteConfirmation(null)} className="px-4 py-2 text-slate-300">Cancelar</button>
                                    <button onClick={() => handleRemoveMember(deleteConfirmation)} className="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded font-bold">Excluir</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Config Modal (Com Abas de Permiss√£o) */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-2xl shadow-2xl animate-fade-in flex flex-col max-h-[90vh]">
                                
                                {/* Header Tabs */}
                                <div className="flex border-b border-slate-700">
                                    <button onClick={() => setSettingsTab('roles')} className={`flex-1 p-4 font-bold text-sm ${settingsTab === 'roles' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-slate-800' : 'text-slate-400 hover:text-white bg-slate-900/50'}`}>
                                        <Settings size={16} className="inline mr-2"/> Cargos das Organiza√ß√µes
                                    </button>
                                    <button onClick={() => setSettingsTab('permissions')} className={`flex-1 p-4 font-bold text-sm ${settingsTab === 'permissions' ? 'text-emerald-400 border-b-2 border-emerald-400 bg-slate-800' : 'text-slate-400 hover:text-white bg-slate-900/50'}`}>
                                        <ShieldCheck size={16} className="inline mr-2"/> Controle de Acesso (RBAC)
                                    </button>
                                </div>

                                <div className="p-6 overflow-y-auto scroll-custom">
                                    
                                    {/* ABA DE CARGOS */}
                                    {settingsTab === 'roles' && (
                                        <div className="space-y-6">
                                            {Object.values(ORG_CONFIG).map(org => (
                                                <div key={org.id} className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                    <h3 className={`text-sm uppercase font-bold ${org.color} mb-3 flex items-center gap-2`}>{React.createElement(Icons[org.icon], {size: 16})} {org.name}</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div className="flex flex-col gap-1">
                                                            <label className="text-xs text-slate-400">Cargo de Membro (Padr√£o)</label>
                                                            <select className="bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm outline-none focus:border-cyan-500" value={roleConfig[org.id] || ""} onChange={(e) => setRoleConfig({...roleConfig, [org.id]: e.target.value})}>
                                                                <option value="">Selecione...</option>
                                                                {discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}
                                                            </select>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div className="flex flex-col gap-1">
                                                                <label className="text-xs text-yellow-400">Cargo de L√≠der</label>
                                                                <select className="bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm outline-none focus:border-yellow-500" value={leaderRoleConfig[org.id] || ""} onChange={(e) => setLeaderRoleConfig({...leaderRoleConfig, [org.id]: e.target.value})}>
                                                                    <option value="">Selecione...</option>
                                                                    {discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}
                                                                </select>
                                                            </div>
                                                            <div className="flex flex-col gap-1">
                                                                <label className="text-xs text-blue-400">Secund√°rio</label>
                                                                <select className="bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm outline-none focus:border-blue-500" value={secLeaderRoleConfig[org.id] || ""} onChange={(e) => setSecLeaderRoleConfig({...secLeaderRoleConfig, [org.id]: e.target.value})}>
                                                                    <option value="">Selecione...</option>
                                                                    {discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* ABA DE PERMISS√ïES */}
                                    {settingsTab === 'permissions' && (
                                        <div className="space-y-6">
                                            <div className="bg-yellow-900/10 border border-yellow-600/30 p-4 rounded-lg mb-6">
                                                <h3 className="text-yellow-400 font-bold flex items-center gap-2 mb-2"><ShieldCheck size={18}/> √Årea de Seguran√ßa</h3>
                                                <p className="text-xs text-slate-400">Defina quais cargos do Discord t√™m permiss√£o para gerenciar o painel. <br/><strong>Aten√ß√£o:</strong> O Criador tem acesso total independente dos cargos.</p>
                                            </div>

                                            <div className="space-y-4">
                                                {/* Criador */}
                                                <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                    <label className="text-sm font-bold text-purple-400 mb-2 block flex items-center gap-2"><UserCog size={16}/> Criador (Super Admin - Acesso Absoluto)</label>
                                                    <div className="relative">
                                                        {/* Usando um select simples dos membros do discord para escolher o criador */}
                                                        <select 
                                                            className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none focus:border-purple-500"
                                                            value={accessConfig.creatorId || ""}
                                                            onChange={(e) => setAccessConfig({...accessConfig, creatorId: e.target.value})}
                                                        >
                                                            <option value="">Selecione o Usu√°rio Criador...</option>
                                                            {discordRoster.map(u => (
                                                                <option key={u.id} value={u.id}>{u.displayName || u.username}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <p className="text-[10px] text-slate-500 mt-1">Este usu√°rio pode editar tudo, inclusive estas configura√ß√µes.</p>
                                                </div>

                                                {/* Admins Globais */}
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                        <label className="text-sm font-bold text-red-400 mb-2 block">Cargo Kage (Admin Global)</label>
                                                        <select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none focus:border-red-500" value={accessConfig.kamiRoleId || ""} onChange={(e) => setAccessConfig({...accessConfig, kamiRoleId: e.target.value})}>
                                                            <option value="">Selecione Cargo...</option>
                                                            {discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}
                                                        </select>
                                                    </div>
                                                    <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                        <label className="text-sm font-bold text-orange-400 mb-2 block">Cargo Conselho (Admin Global)</label>
                                                        <select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none focus:border-orange-500" value={accessConfig.councilRoleId || ""} onChange={(e) => setAccessConfig({...accessConfig, councilRoleId: e.target.value})}>
                                                            <option value="">Selecione Cargo...</option>
                                                            {discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}
                                                        </select>
                                                    </div>
                                                </div>

                                                {/* Visualiza√ß√£o */}
                                                <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                    <label className="text-sm font-bold text-blue-400 mb-2 block">Cargo Moderador (Apenas Visualiza√ß√£o)</label>
                                                    <select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500" value={accessConfig.moderatorRoleId || ""} onChange={(e) => setAccessConfig({...accessConfig, moderatorRoleId: e.target.value})}>
                                                        <option value="">Selecione Cargo...</option>
                                                        {discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}
                                                    </select>
                                                    <p className="text-[10px] text-slate-500 mt-1">Usu√°rios com este cargo podem ver tudo mas n√£o podem editar nada.</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                </div>
                                <div className="p-6 border-t border-slate-700 bg-slate-900/50 rounded-b-xl flex justify-between items-center">
                                    <span className="text-xs text-slate-500">Altera√ß√µes afetam o acesso imediatamente.</span>
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-400 hover:text-white">Cancelar</button>
                                        {/* S√≥ mostra bot√£o de salvar config se tiver permiss√£o de SETTINGS */}
                                        {canManageSettings && (
                                            <button onClick={handleSaveConfig} className="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-2 rounded font-bold">Salvar Configura√ß√£o</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="border-b border-slate-800 bg-slate-900/90 backdrop-blur sticky top-0 z-50">
                        <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-cyan-900/30 rounded border border-cyan-500/30 text-cyan-400"><RefreshCw size={20} className={loading ? 'animate-spin' : ''} /></div>
                                <h1 className="text-xl md:text-2xl font-bold mist-title text-cyan-50 tracking-wider">N√©voa <span className="text-cyan-500">System</span></h1>
                            </div>
                            <div className="flex items-center gap-4">
                                {canViewHistory && (
                                    <>
                                        <button onClick={() => setActiveTab('access')} className={`p-2 text-slate-400 hover:text-green-400 transition-colors ${activeTab === 'access' ? 'text-green-400 bg-green-400/10 rounded-lg' : ''}`} title="Monitoramento de Acesso">
                                            <Globe size={20} />
                                        </button>
                                        <button onClick={() => setActiveTab('history')} className={`p-2 text-slate-400 hover:text-purple-400 transition-colors ${activeTab === 'history' ? 'text-purple-400 bg-purple-400/10 rounded-lg' : ''}`} title="Hist√≥rico de Modifica√ß√µes">
                                            <History size={20} />
                                        </button>
                                    </>
                                )}
                                {/* Bot√£o de Engrenagem s√≥ aparece se tiver permiss√£o de gerenciar settings */}
                                {canManageSettings && (
                                    <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-cyan-400 transition-colors"><Settings size={20} /></button>
                                )}
                                <div className="flex items-center gap-2 px-3 py-1 bg-slate-800 rounded-full border border-slate-700">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <span className="text-xs font-bold text-slate-300 hidden md:inline">{user.username}</span>
                                </div>
                                <button onClick={() => { localStorage.removeItem('discord_access_token'); setUser(null); }} className="text-slate-400 hover:text-red-400 transition-colors"><LogOut size={20} /></button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto px-6 py-8">
                        {notification && <div className={`fixed bottom-4 right-4 p-4 rounded shadow-lg text-white z-50 animate-bounce-in ${notification.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>{notification.msg}</div>}

                        {activeTab === 'dashboard' ? (
                            <div className="animate-fade-in space-y-8">
                                {/* Dashboard Principal (Cubes) */}
                                {multiOrgUsers.length > 0 && (
                                    <div className="bg-yellow-900/20 border border-yellow-600/30 rounded-xl p-6">
                                        <h3 className="text-yellow-400 font-bold flex items-center gap-2 mb-4"><AlertTriangle size={20} /> Conflitos de Organiza√ß√£o</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {multiOrgUsers.map((u, idx) => (
                                                <div key={idx} className="bg-slate-800/50 p-3 rounded border border-yellow-700/20 flex flex-col">
                                                    <span className="font-bold text-white">{u.name}</span>
                                                    <span className="text-xs text-slate-400 mt-1">Membro de: <span className="text-yellow-200">{u.orgs.join(", ")}</span></span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {Object.values(ORG_CONFIG).map((org) => {
                                        const count = members.filter(m => m.org === org.id).length;
                                        const percentage = (count / org.limit) * 100;
                                        const IconComponent = Icons[org.icon];
                                        return (
                                            <div key={org.id} onClick={() => setActiveTab(org.id)} className={`glass-panel p-6 rounded-xl cursor-pointer hover:scale-105 transition-all hover:shadow-lg hover:shadow-cyan-500/10 ${org.border} border-t-4`}>
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className={`p-3 rounded-lg ${org.bgColor} ${org.color}`}><IconComponent /></div>
                                                    <span className="text-2xl font-bold font-mono">{count}/{org.limit}</span>
                                                </div>
                                                <h3 className="text-lg font-bold mb-1">{org.name}</h3>
                                                <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden mt-2">
                                                    <div className={`h-full transition-all duration-500 ${org.color.replace('text', 'bg')}`} style={{ width: `${percentage}%` }}></div>
                                                </div>
                                                {!roleConfig[org.id] && <p className="text-[10px] text-red-400 mt-2 flex items-center gap-1"><AlertCircle size={10}/> Cargo n√£o configurado</p>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : activeTab === 'history' ? (
                            <div className="animate-fade-in">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setActiveTab('dashboard')} className="p-2 hover:bg-slate-700 rounded transition-colors text-white">‚Üê Voltar</button>
                                        <div className="p-3 rounded-lg bg-purple-900/20 text-purple-400"><History size={20} /></div>
                                        <h2 className="text-3xl font-bold mist-title text-white">Hist√≥rico de Modifica√ß√µes</h2>
                                    </div>
                                </div>

                                <div className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-800/50 text-slate-400 text-xs uppercase">
                                            <tr>
                                                <th className="p-4">Data/Hora</th>
                                                <th className="p-4">Executor</th>
                                                <th className="p-4">A√ß√£o</th>
                                                <th className="p-4">Alvo</th>
                                                <th className="p-4">Detalhes</th>
                                                <th className="p-4">Origem</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {auditLogs.length === 0 ? (
                                                <tr>
                                                    <td colSpan="6" className="p-8 text-center text-slate-500 italic">Nenhum registro encontrado ainda.</td>
                                                </tr>
                                            ) : (
                                                auditLogs.map((log) => (
                                                    <tr key={log.id} className="hover:bg-slate-800/30 transition-colors">
                                                        <td className="p-4 text-xs font-mono text-slate-400">{new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                                                        <td className="p-4 font-bold text-cyan-400">{log.executor}</td>
                                                        <td className="p-4">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold border 
                                                                ${log.action.includes('Adicionar') ? 'border-emerald-500/30 text-emerald-400 bg-emerald-900/20' : 
                                                                log.action.includes('Remover') ? 'border-red-500/30 text-red-400 bg-red-900/20' : 
                                                                log.action.includes('Editar') ? 'border-blue-500/30 text-blue-400 bg-blue-900/20' : 
                                                                'border-yellow-500/30 text-yellow-400 bg-yellow-900/20'}`}>
                                                                {log.action}
                                                            </span>
                                                        </td>
                                                        <td className="p-4 text-white font-bold">{log.target}</td>
                                                        <td className="p-4 text-sm text-slate-300">{log.details}</td>
                                                        <td className="p-4 text-xs text-slate-500 uppercase">{ORG_CONFIG[log.org]?.name || log.org}</td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : activeTab === 'access' ? (
                            <div className="animate-fade-in space-y-8">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setActiveTab('dashboard')} className="p-2 hover:bg-slate-700 rounded transition-colors text-white">‚Üê Voltar</button>
                                        <div className="p-3 rounded-lg bg-green-900/20 text-green-400"><Globe size={20} /></div>
                                        <h2 className="text-3xl font-bold mist-title text-white">Monitoramento de Acesso</h2>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    {/* COLUNA 1: ONLINE AGORA */}
                                    <div className="bg-slate-900/50 border border-green-500/30 rounded-xl p-6 h-full">
                                        <h3 className="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
                                            <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                            Online Agora ({onlineUsers.length})
                                        </h3>
                                        {onlineUsers.length === 0 ? (
                                            <p className="text-slate-500 italic">Nenhum usu√°rio ativo no momento.</p>
                                        ) : (
                                            <div className="space-y-3">
                                                {onlineUsers.map((u, idx) => (
                                                    <div key={idx} className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold overflow-hidden">
                                                                {u.avatar ? <img src={`https://cdn.discordapp.com/avatars/${u.userId}/${u.avatar}.png`} className="w-full h-full" /> : u.username?.charAt(0)}
                                                            </div>
                                                            <span className="font-bold text-white">{u.username}</span>
                                                        </div>
                                                        <span className="text-xs text-green-400 font-mono">Ativo</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* COLUNA 2: HIST√ìRICO DE ACESSO */}
                                    <div className="glass-panel rounded-xl overflow-hidden border border-slate-700 h-full">
                                        <div className="p-4 bg-slate-800/50 border-b border-slate-700">
                                            <h3 className="text-lg font-bold text-slate-300">√öltimos Acessos</h3>
                                        </div>
                                        <div className="max-h-[500px] overflow-y-auto scroll-custom">
                                            <table className="w-full text-left">
                                                <tbody className="divide-y divide-slate-700">
                                                    {accessLogs.map((log) => (
                                                        <tr key={log.id} className="hover:bg-slate-800/30">
                                                            <td className="p-4 text-xs font-mono text-slate-400 w-32">{new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                                                            <td className="p-4">
                                                                <span className="font-bold text-cyan-400 block">{log.username}</span>
                                                                <span className="text-xs text-slate-500">ID: {log.userId}</span>
                                                            </td>
                                                            <td className="p-4 text-right">
                                                                <span className="text-xs bg-slate-800 px-2 py-1 rounded text-slate-300 border border-slate-700">Login no Painel</span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setActiveTab('dashboard')} className="p-2 hover:bg-slate-700 rounded transition-colors text-white">‚Üê Voltar</button>
                                        <div className={`p-3 rounded-lg ${ORG_CONFIG[activeTab].bgColor} ${ORG_CONFIG[activeTab].color}`}>{React.createElement(Icons[ORG_CONFIG[activeTab].icon])}</div>
                                        <h2 className="text-3xl font-bold mist-title text-white">{ORG_CONFIG[activeTab].name}</h2>
                                    </div>
                                    <span className={`text-2xl font-bold ${members.filter(m => m.org === activeTab).length >= ORG_CONFIG[activeTab].limit ? 'text-red-400' : 'text-emerald-400'}`}>
                                        {members.filter(m => m.org === activeTab).length} / {ORG_CONFIG[activeTab].limit}
                                    </span>
                                </div>

                                {/* SE√á√ÉO DE DETALHES DOS CARGOS (EXPANS√çVEL) */}
                                {ORG_CONFIG[activeTab].roleDetails && (
                                    <div className="mb-6">
                                        <button 
                                            onClick={() => setShowRoleDetails(!showRoleDetails)}
                                            className="w-full bg-slate-800/50 hover:bg-slate-800 border border-slate-700 rounded-lg p-3 flex justify-between items-center transition-all text-slate-300 hover:text-white"
                                        >
                                            <span className="font-bold flex items-center gap-2"><BookOpen size={18}/> Hierarquia & Cargos</span>
                                            {showRoleDetails ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                        </button>
                                        
                                        {showRoleDetails && (
                                            <div className="mt-2 bg-slate-900/50 border border-slate-700 rounded-lg p-4 animate-fade-in grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {ORG_CONFIG[activeTab].roleDetails.map((role, idx) => (
                                                    <div key={idx} className="flex flex-col border-l-2 border-slate-600 pl-3">
                                                        <span className="text-sm font-bold text-cyan-400">{role.name}</span>
                                                        <span className="text-xs text-slate-400">{role.desc}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Bot√£o ADD protegido por permiss√£o */}
                                {canManageOrg(activeTab) && (
                                    <div className="mb-6 flex justify-end">
                                        <button 
                                            onClick={openCreateModal}
                                            className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg shadow-cyan-500/20 transition-all hover:scale-105"
                                        >
                                            <UserPlus size={20} /> Adicionar Novo Membro
                                        </button>
                                    </div>
                                )}

                                <div className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-800/50 text-slate-400 text-xs uppercase">
                                            <tr>
                                                <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('role')}>Cargo Discord <SortIcon k="role"/></th>
                                                <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('name')}>Nome <SortIcon k="name"/></th>
                                                <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('ninRole')}>Cargo Nin <SortIcon k="ninRole"/></th>
                                                <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('joinDate')}>Entrada <SortIcon k="joinDate"/></th>
                                                <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('activity')}>Atividade (14d) <SortIcon k="activity"/></th>
                                                <th className="p-4 text-center cursor-pointer hover:text-white" onClick={() => requestSort('isLeader')}>L√≠der <SortIcon k="isLeader"/></th>
                                                {/* S√≥ mostra coluna A√ß√µes se tiver permiss√£o de gerenciar essa org */}
                                                {canManageOrg(activeTab) && <th className="p-4 text-right">A√ß√µes</th>}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {getSortedMembers(members.filter(m => m.org === activeTab)).map((member) => {
                                                const leaderRoleId = leaderRoleConfig[member.org];
                                                const leaderRoleName = member.isLeader && leaderRoleId ? discordRoles.find(r => r.id === leaderRoleId)?.name : null;
                                                const orgInfo = getMemberOrgsInfo(member.discordId);
                                                const memberMasteries = member.masteries || [];
                                                const activity = getActivityStats(member);

                                                return (
                                                    <tr key={member.id} 
                                                        className={`hover:bg-slate-800/30 transition-colors cursor-pointer ${member.isLeader ? 'bg-yellow-900/10' : ''}`}
                                                        onClick={() => {
                                                            // S√≥ abre o modal se tiver permiss√£o, sen√£o n√£o faz nada
                                                            if(canManageOrg(activeTab)) openEditModal(member);
                                                        }}
                                                    >
                                                        <td className="p-4">
                                                            <div className="flex flex-col gap-1 items-start">
                                                                <span className={`px-2 py-1 rounded text-xs font-bold border ${ORG_CONFIG[activeTab].border} ${ORG_CONFIG[activeTab].color} bg-opacity-10`}>{member.role}</span>
                                                                {leaderRoleName && <span className="px-2 py-1 rounded text-xs font-bold border border-yellow-500/50 text-yellow-400 bg-yellow-900/20">{leaderRoleName}</span>}
                                                            </div>
                                                        </td>
                                                        <td className="p-4">
                                                            <div className="flex flex-col">
                                                                <span className="font-bold text-white flex items-center gap-2">
                                                                    {member.name}
                                                                    {orgInfo && (
                                                                        <div className="text-yellow-400 cursor-help relative group" title={`Membro de: ${orgInfo.names}`} onClick={(e) => e.stopPropagation()}>
                                                                            <AlertCircle size={14} />
                                                                        </div>
                                                                    )}
                                                                </span>
                                                                <div className="flex flex-wrap gap-2 mt-1">
                                                                    {memberMasteries.map(m => {
                                                                        const mData = MASTERIES.find(mastery => mastery.id === m);
                                                                        if (!mData) return null;
                                                                        return (
                                                                            <div key={m} className={`flex items-center gap-1 ${mData.color} bg-slate-800/50 px-1.5 py-0.5 rounded text-[10px] font-bold border border-${mData.color.split('-')[1]}-500/20`}>
                                                                            {React.createElement(mData.icon, {size: 12})}
                                                                            <span>{m}</span>
                                                                            </div>
                                                                        )
                                                                    })}
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td className="p-4"><span className="text-slate-300 text-sm">{member.ninRole}</span></td>
                                                        <td className="p-4"><span className="text-slate-300 text-sm font-mono">{formatDate(member.joinDate)}</span></td>
                                                        
                                                        {/* COLUNA DE ATIVIDADE */}
                                                        <td className="p-4">
                                                            <div className="flex items-center gap-2" title={`√öltimas 2 semanas: ${activity.details.msgs} msgs / ${activity.details.voice} voz`}>
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white ${activity.color} shadow-lg shadow-${activity.color}/50`}>
                                                                    <span className="text-lg">{activity.icon}</span>
                                                                </div>
                                                                <div className="flex flex-col w-24">
                                                                    <span className="text-[10px] uppercase font-bold text-slate-400">{activity.tier}</span>
                                                                    <div className="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden mt-1">
                                                                        <div className={`h-full ${activity.color}`} style={{ width: activity.width }}></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>

                                                        <td className="p-4 text-center">
                                                            {/* S√≥ mostra bot√£o de Toggle se tiver permiss√£o, sen√£o s√≥ mostra √≠cone */}
                                                            {canManageOrg(activeTab) ? (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); handleToggleLeader(member); }}
                                                                    className={`p-2 rounded-full transition-all ${member.isLeader ? 'text-yellow-400 bg-yellow-400/10' : 'text-slate-600 hover:text-yellow-400'}`}
                                                                    title={member.isLeader ? "Remover Lideran√ßa" : "Promover a L√≠der"}
                                                                >
                                                                    <Crown size={18} fill={member.isLeader ? "currentColor" : "none"} />
                                                                </button>
                                                            ) : (
                                                                member.isLeader && <Crown size={18} className="text-yellow-400 inline-block" fill="currentColor"/>
                                                            )}
                                                        </td>
                                                        
                                                        {/* Bot√µes de A√ß√£o Protegidos */}
                                                        {canManageOrg(activeTab) && (
                                                            <td className="p-4 text-right" onClick={(e) => e.stopPropagation()}>
                                                                <button onClick={() => setDeleteConfirmation(member.id)} className="text-slate-500 hover:text-red-400 p-2"><Trash2 size={16} /></button>
                                                            </td>
                                                        )}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
