<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Névoa do Nin Online</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (para JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Roboto Mono', monospace;
        }
        
        .mist-title {
            font-family: 'Cinzel', serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .scroll-custom::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-custom::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .scroll-custom::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        .scroll-custom::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SHIMS E UTILITÁRIOS PARA RODAR NO NAVEGADOR ---

        // 1. Adaptador de Ícones Lucide para React
        const LucideIcon = ({ name, size = 20, className = "", ...props }) => {
            if (!window.lucide || !window.lucide.icons || !window.lucide.icons[name]) return null;
            
            const svgString = window.lucide.icons[name].toSvg({
                class: className,
                width: size,
                height: size,
                stroke: "currentColor",
                "stroke-width": 2,
                "stroke-linecap": "round",
                "stroke-linejoin": "round",
                fill: props.fill || "none"
            });

            return <span dangerouslySetInnerHTML={{ __html: svgString }} className={`inline-flex items-center justify-center ${className}`} {...props} />;
        };

        // Gera componentes React para cada ícone usado no código
        const iconList = [
            "Swords", "Shield", "Activity", "Ghost", "Users", "UserPlus", "Trash2", 
            "Save", "RefreshCw", "AlertCircle", "Menu", "LogOut", "Search", "Settings", "X", 
            "AlertTriangle", "Crown", "ArrowUp", "ArrowDown", "ArrowUpDown",
            "Heart", "Zap", "Flame", "Droplets", "Mountain", "Wind", "CloudLightning", 
            "Cross", "Target", "Circle", "Calendar", "Info", "Lock", "Database", "Clock", 
            "MessageSquare", "Mic", "ShieldCheck", "UserCog"
        ];
        
        const Icons = {};
        iconList.forEach(name => {
            Icons[name] = (props) => <LucideIcon name={name} {...props} />;
        });

        // Destrutura para uso direto no código (ex: <Ghost />)
        const { 
            Swords, Shield, Activity, Ghost, Users, UserPlus, Trash2, 
            Save, RefreshCw, AlertCircle, Menu, LogOut, Search, Settings, X, 
            AlertTriangle, Crown, ArrowUp, ArrowDown, ArrowUpDown,
            Heart, Zap, Flame, Droplets, Mountain, Wind, CloudLightning, 
            Cross, Target, Circle, Calendar, Info, Lock, Database, Clock, MessageSquare, Mic, ShieldCheck, UserCog
        } = Icons;


        // 2. Adaptador Firebase Modular -> Compat (Para rodar sem build)
        const firebaseConfig = {
            apiKey: "AIzaSyBtpZZaQElw7ieRgXaD3wJ_7EyNwEB9RVo",
            authDomain: "nevoasystem.firebaseapp.com",
            projectId: "nevoasystem",
            storageBucket: "nevoasystem.firebasestorage.app",
            messagingSenderId: "887482895210",
            appId: "1:887482895210:web:1177bbc7fe859d1db37313",
            measurementId: "G-545J0LDVTY"
        };

        // Inicializa se necessário
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Funções Shim para imitar a API Modular v9 usando a API Compat v8
        const initializeApp = () => firebase.app();
        const getAnalytics = () => firebase.analytics();
        const getFirestore = () => firebase.firestore();
        
        const collection = (db, ...pathSegments) => {
            return db.collection(pathSegments.join('/'));
        };
        
        const doc = (db, ...pathSegments) => {
            // Se passar (db, 'col', 'id'), vira db.collection('col').doc('id')
            if (pathSegments.length === 2) {
                return db.collection(pathSegments[0]).doc(pathSegments[1]);
            }
            // Se passar (db, 'col/id'), vira db.doc('col/id')
            return db.doc(pathSegments[0]);
        };

        const onSnapshot = (ref, next, error) => ref.onSnapshot(next, error);
        const setDoc = (ref, data) => ref.set(data);
        const updateDoc = (ref, data) => ref.update(data);
        const deleteDoc = (ref) => ref.delete();
        const getDoc = (ref) => ref.get();
        const writeBatch = (db) => db.batch();


        // --- APLICAÇÃO PRINCIPAL (APP.JSX) ---

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        const App = () => {
            // CONFIGURAÇÕES DO DISCORD
            const DISCORD_CLIENT_ID = "1453817939265589452"; 
            const GUILD_ID = "1410456333391761462"; // ID do Servidor da Névoa
            
            // --- ESTADOS ---
            const [user, setUser] = useState(null); // { id, username, roles: [] }
            const [members, setMembers] = useState([]); 
            const [discordRoster, setDiscordRoster] = useState([]); 
            const [discordRoles, setDiscordRoles] = useState([]); 
            
            // Configurações de Mapeamento
            const [roleConfig, setRoleConfig] = useState({}); 
            const [leaderRoleConfig, setLeaderRoleConfig] = useState({}); 
            const [secLeaderRoleConfig, setSecLeaderRoleConfig] = useState({}); 
            
            // Configurações de Acesso (Permissões)
            const [accessConfig, setAccessConfig] = useState({
                kamiRoleId: '',
                councilRoleId: '',
                moderatorRoleId: '',
                creatorId: ''
            });

            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [notification, setNotification] = useState(null);
            
            // Estado do Novo Membro
            const [newMember, setNewMember] = useState({ 
                name: '', 
                discordId: '', 
                role: '', 
                specificRoleId: '', 
                ninRole: '', 
                isLeader: false,
                joinDate: new Date().toISOString().split('T')[0]
            });
            
            const [showSettings, setShowSettings] = useState(false); 
            const [settingsTab, setSettingsTab] = useState('roles'); // 'roles' ou 'permissions'
            const [deleteConfirmation, setDeleteConfirmation] = useState(null);
            
            // ESTADOS DE EDIÇÃO DE MEMBRO
            const [selectedMember, setSelectedMember] = useState(null); 
            const [editForm, setEditForm] = useState(null); 
            const [isCreating, setIsCreating] = useState(false);

            const [sortConfig, setSortConfig] = useState({ key: 'rank', direction: 'descending' });
            const [searchTerm, setSearchTerm] = useState("");
            const [isDropdownOpen, setIsDropdownOpen] = useState(false);

            // --- CONSTANTES DE RPG ---
            const MASTERIES = [
                { id: 'Fogo', icon: Flame, color: 'text-orange-500' },
                { id: 'Água', icon: Droplets, color: 'text-blue-500' },
                { id: 'Terra', icon: Mountain, color: 'text-amber-700' },
                { id: 'Vento', icon: Wind, color: 'text-slate-400' },
                { id: 'Raio', icon: CloudLightning, color: 'text-yellow-400' },
                { id: 'Médico', icon: Cross, color: 'text-emerald-400' },
                { id: 'Taijutsu', icon: Activity, color: 'text-red-500' },
                { id: 'Arma', icon: Target, color: 'text-gray-300' },
                { id: 'Bolha', icon: Circle, color: 'text-cyan-300' }
            ];

            const STATS = ['Força', 'Fortitude', 'Intelecto', 'Agilidade', 'Chakra'];

            const ORG_CONFIG = {
                'sete-laminas': { 
                    id: 'sete-laminas', 
                    name: 'Sete Lâminas', 
                    icon: Swords, 
                    color: 'text-red-400', 
                    bgColor: 'bg-red-900/20', 
                    border: 'border-red-500/30', 
                    limit: 7, 
                    internalRoles: ['Espadachim Iniciante', 'Portador da Espada', 'Mestre das Lâminas'] 
                },
                'divisao-especial': { 
                    id: 'divisao-especial', 
                    name: 'Divisão Especial (ANBU)', 
                    icon: Ghost, 
                    color: 'text-purple-400', 
                    bgColor: 'bg-purple-900/20', 
                    border: 'border-purple-500/30', 
                    limit: 14, 
                    internalRoles: ['Recruta', 'Agente', 'Capitão', 'Comandante'] 
                },
                'forca-policial': { 
                    id: 'forca-policial', 
                    name: 'Força Policial', 
                    icon: Shield, 
                    color: 'text-blue-400', 
                    bgColor: 'bg-blue-900/20', 
                    border: 'border-blue-500/30', 
                    limit: 20, 
                    internalRoles: ['Cadete', 'Oficial', 'Sargento', 'Delegado'] 
                },
                'unidade-medica': { 
                    id: 'unidade-medica', 
                    name: 'Unidade Médica', 
                    icon: Activity, 
                    color: 'text-emerald-400', 
                    bgColor: 'bg-emerald-900/20', 
                    border: 'border-emerald-500/30', 
                    limit: 20, 
                    internalRoles: ['Estagiário', 'Médico de Campo', 'Médico Júnior', 'Doutor', 'Residente Chefe', 'Diretor Médico'] 
                }
            };

            // --- SINCRONIZAÇÃO ---
            useEffect(() => {
                const unsubMembers = onSnapshot(collection(db, "membros"), (snap) => setMembers(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))), () => setLoading(false));
                const unsubRoster = onSnapshot(doc(db, "server", "roster"), (doc) => { if (doc.exists()) setDiscordRoster(doc.data().users || []); });
                const unsubRoles = onSnapshot(doc(db, "server", "roles"), (doc) => { if (doc.exists()) setDiscordRoles(doc.data().list || []); });
                const unsubConfig = onSnapshot(doc(db, "server", "config"), (doc) => { 
                    if (doc.exists()) {
                        const data = doc.data();
                        setRoleConfig(data.roleMapping || {});
                        setLeaderRoleConfig(data.leaderRoleMapping || {});
                        setSecLeaderRoleConfig(data.secLeaderRoleMapping || {});
                        setAccessConfig(data.accessConfig || { kamiRoleId: '', councilRoleId: '', moderatorRoleId: '', creatorId: '' });
                    }
                });
                return () => { unsubMembers(); unsubRoster(); unsubRoles(); unsubConfig(); };
            }, []);

            // --- SISTEMA DE PERMISSÕES ---
            const checkPermission = (action, contextOrgId = null) => {
                if (!user) return false;
                if (user.id === accessConfig.creatorId) return true;

                const userRoles = user.roles || [];

                if (userRoles.includes(accessConfig.kamiRoleId) || userRoles.includes(accessConfig.councilRoleId)) {
                    return true;
                }

                if (action === 'MANAGE_SETTINGS') return false;

                if (action === 'EDIT_MEMBER' || action === 'ADD_MEMBER' || action === 'DELETE_MEMBER') {
                    if (userRoles.includes(accessConfig.moderatorRoleId)) return false;
                    if (contextOrgId) {
                        const leaderRoleId = leaderRoleConfig[contextOrgId];
                        if (leaderRoleId && userRoles.includes(leaderRoleId)) {
                            return true;
                        }
                    }
                }
                return false;
            };

            const canManageOrg = (orgId) => checkPermission('EDIT_MEMBER', orgId);
            const canManageSettings = checkPermission('MANAGE_SETTINGS');

            // --- LÓGICA DE RPG (CÁLCULOS) ---
            const calculateMaxPoints = (level) => {
                if (level <= 1) return 0; 
                let points = 0;
                const levelsTo50 = Math.min(level, 50) - 1;
                points += levelsTo50 * 5;
                if (level > 50) points += (level - 50) * 4;
                return points;
            };

            const calculateStats = (baseStats, hasBonus) => {
                const stats = { ...baseStats };
                const bonusMultiplier = hasBonus ? 1.10 : 1;
                let calculated = {};
                STATS.forEach(key => calculated[key] = Math.floor(stats[key] * bonusMultiplier));
                const fortitudeExtra = Math.max(0, calculated['Fortitude'] - 5);
                const hp = 250 + (fortitudeExtra * 8);
                const chakraExtra = Math.max(0, calculated['Chakra'] - 5);
                const cp = 50 + (chakraExtra * 5);
                return { ...calculated, hp, cp };
            };

            // --- LÓGICA DE ATIVIDADE ---
            const getActivityStats = (activityMap) => {
                if (!activityMap) return { total: 0, tier: 'Fantasma', color: 'bg-red-500', icon: Ghost };
                let total = 0;
                const today = new Date();
                for (let i = 0; i < 14; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    total += (activityMap[dateStr] || 0);
                }
                let tier = 'Fantasma', color = 'bg-red-500', icon = Ghost, width = '5%';
                if (total > 250) { tier = 'Lendário'; color = 'bg-purple-500'; icon = Crown; width = '100%'; }
                else if (total > 50) { tier = 'Ativo'; color = 'bg-emerald-500'; icon = Flame; width = '75%'; }
                else if (total > 10) { tier = 'Regular'; color = 'bg-blue-500'; icon = MessageSquare; width = '50%'; }
                else if (total > 0) { tier = 'Adormecido'; color = 'bg-yellow-500'; icon = Clock; width = '25%'; }
                return { total, tier, color, icon, width };
            };

            // --- AÇÕES DO SISTEMA ---
            const openCreateModal = () => {
                setIsCreating(true);
                setSearchTerm("");
                const orgId = activeTab;
                const defaultRole = ORG_CONFIG[orgId].internalRoles[0];
                setEditForm({
                    name: '', discordId: '', org: orgId, ninRole: defaultRole, specificRoleId: '', isLeader: false,
                    level: 1, guildBonus: false, masteries: [],
                    stats: { Força: 5, Fortitude: 5, Intelecto: 5, Agilidade: 5, Chakra: 5 },
                    joinDate: new Date().toISOString().split('T')[0]
                });
                setSelectedMember({ org: orgId });
            };

            const handleSaveEdit = async () => {
                if (!selectedMember || !editForm) return;
                const orgId = isCreating ? activeTab : selectedMember.org;
                if (!checkPermission(isCreating ? 'ADD_MEMBER' : 'EDIT_MEMBER', orgId)) return showNotification('Sem permissão.', 'error');
                
                if (!editForm.name || !editForm.discordId) return showNotification('Selecione um usuário!', 'error');

                const docId = isCreating ? `${editForm.discordId}_${orgId}` : selectedMember.id;
                
                let finalRoleId = editForm.specificRoleId;
                let finalRoleName = "Membro";
                if (!finalRoleId) finalRoleId = roleConfig[orgId];
                if (finalRoleId) {
                    const r = discordRoles.find(role => role.id === finalRoleId);
                    if (r) finalRoleName = r.name;
                } else if (isCreating) return showNotification('Configure o Cargo Padrão!', 'error');

                if (editForm.isLeader) {
                     const currentLeader = members.find(m => m.org === orgId && m.isLeader === true && m.discordId !== editForm.discordId);
                     if (currentLeader) {
                         let newRoleForOldLeader = currentLeader.ninRole;
                         if (orgId === 'unidade-medica' && currentLeader.ninRole === 'Diretor Médico') newRoleForOldLeader = 'Residente Chefe';
                         await updateDoc(doc(db, "membros", currentLeader.id), { isLeader: false, ninRole: newRoleForOldLeader });
                     }
                     if (orgId === 'unidade-medica') editForm.ninRole = 'Diretor Médico';
                }

                const payload = {
                    ...editForm, org: orgId, role: finalRoleName, specificRoleId: finalRoleId,
                    status: 'Ativo', updatedAt: new Date().toISOString(), statsUpdatedAt: new Date().toISOString()
                };

                try {
                    if (isCreating) {
                         const currentCount = members.filter(m => m.org === orgId).length;
                         if (currentCount >= ORG_CONFIG[orgId].limit) return showNotification('Limite atingido!', 'error');
                         await setDoc(doc(db, "membros", docId), payload);
                    } else {
                        await updateDoc(doc(db, "membros", docId), payload);
                    }
                    showNotification('Salvo com sucesso!', 'success');
                    setSelectedMember(null); setEditForm(null);
                } catch(e) { showNotification('Erro: ' + e.message, 'error'); }
            };

            const handleRemoveMember = async (id) => {
                if(!deleteConfirmation) return;
                if (!checkPermission('DELETE_MEMBER', activeTab)) return showNotification('Sem permissão.', 'error');
                try {
                    await deleteDoc(doc(db, "membros", String(deleteConfirmation)));
                    showNotification('Removido.', 'success');
                    setDeleteConfirmation(null);
                } catch(e) { alert(`Erro: ${e.message}`); setDeleteConfirmation(null); }
            };

            const handleSaveConfig = async () => {
                if (!canManageSettings) return showNotification('Apenas Admins.', 'error');
                try {
                    await setDoc(doc(db, "server", "config"), { 
                        roleMapping: roleConfig, leaderRoleMapping: leaderRoleConfig, 
                        secLeaderRoleMapping: secLeaderRoleConfig, accessConfig 
                    }, { merge: true });
                    showNotification('Configurações Salvas!', 'success');
                    setShowSettings(false);
                } catch(e) { showNotification('Erro ao salvar.', 'error'); }
            };

            const openEditModal = (member) => {
                const defaultStats = { Força: 5, Fortitude: 5, Intelecto: 5, Agilidade: 5, Chakra: 5 };
                setEditForm({
                    ...member,
                    level: member.level || 1,
                    guildBonus: member.guildBonus || false,
                    masteries: member.masteries || [],
                    stats: member.stats || defaultStats,
                    joinDate: member.joinDate || new Date().toISOString().split('T')[0]
                });
                setSelectedMember(member);
            };

            const toggleMastery = (mId) => {
                const cur = editForm.masteries || [];
                setEditForm({...editForm, masteries: cur.includes(mId) ? cur.filter(x=>x!==mId) : [...cur, mId]});
            };
            const updateStat = (s, v) => setEditForm({...editForm, stats: {...editForm.stats, [s]: Math.max(0, parseInt(v)||0)}});
            const handleSelectUser = (u) => { setEditForm({...editForm, name: u.displayName||u.username, discordId: u.id}); setSearchTerm(u.displayName||u.username); setIsDropdownOpen(false); };
            const showNotification = (msg, type) => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };
            
            const handleToggleLeader = async (member) => {
                if (!checkPermission('EDIT_MEMBER', member.org)) return showNotification('Sem permissão.', 'error');
                try {
                    const orgId = member.org;
                    const newStatus = !member.isLeader;
                    if (newStatus === true) {
                        const currentLeader = members.find(m => m.org === orgId && m.isLeader === true);
                        if (currentLeader && currentLeader.id !== member.id) {
                            let newRoleForOldLeader = currentLeader.ninRole;
                            if (orgId === 'unidade-medica' && currentLeader.ninRole === 'Diretor Médico') newRoleForOldLeader = 'Residente Chefe';
                            await updateDoc(doc(db, "membros", currentLeader.id), { isLeader: false, ninRole: newRoleForOldLeader });
                        }
                        let newRoleForNewLeader = member.ninRole;
                        if (orgId === 'unidade-medica') newRoleForNewLeader = 'Diretor Médico';
                        await updateDoc(doc(db, "membros", member.id), { isLeader: true, ninRole: newRoleForNewLeader });
                    } else {
                        await updateDoc(doc(db, "membros", member.id), { isLeader: false });
                    }
                    showNotification(newStatus ? 'Novo Líder!' : 'Liderança removida.', 'success');
                } catch (e) { showNotification('Erro ao alterar liderança.', 'error'); }
            };

            const maxPoints = editForm ? calculateMaxPoints(editForm.level) : 0;
            const usedPoints = editForm ? STATS.reduce((acc, s) => acc + (editForm.stats[s]-5), 0) : 0;
            const remainingPoints = maxPoints - usedPoints;
            const finalVitals = editForm ? calculateStats(editForm.stats, editForm.guildBonus) : {hp:250, cp:50};
            const filteredRoster = discordRoster.filter(u => (u.displayName||u.username).toLowerCase().includes(searchTerm.toLowerCase()));
            
            // Auth
            const handleLogin = (e) => {
                if(e) e.preventDefault();
                const redirectUri = encodeURIComponent(window.location.href.split('#')[0]);
                window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=identify%20guilds.members.read`;
            };

            useEffect(() => { 
                const f = new URLSearchParams(window.location.hash.slice(1)); 
                const token = f.get('access_token');
                const error = f.get('error');

                if (error) {
                    showNotification('Erro no login: ' + error, 'error');
                    window.history.pushState({}, document.title, window.location.pathname);
                    return;
                }

                if(token) {
                    setLoading(true);
                    fetch('https://discord.com/api/users/@me', {headers:{Authorization:`Bearer ${token}`}})
                    .then(r => r.ok ? r.json() : Promise.reject('Falha user'))
                    .then(u => {
                        fetch(`https://discord.com/api/users/@me/guilds/${GUILD_ID}/member`, {headers:{Authorization:`Bearer ${token}`}})
                        .then(r => r.ok ? r.json() : { roles: [] })
                        .then(m => {
                            setUser({...u, roles: m.roles||[]});
                            window.history.pushState({}, document.title, window.location.pathname);
                            showNotification(`Bem-vindo, ${u.username}!`, 'success');
                        });
                    })
                    .catch(err => {
                        console.error("Auth Error", err);
                        showNotification("Falha na autenticação.", "error");
                    })
                    .finally(() => setLoading(false));
                }
            }, []);

            // Sorter
            const getRoleRank = (m) => (ORG_CONFIG[m.org]?.internalRoles || []).indexOf(m.ninRole);
            const requestSort = (key) => setSortConfig({ key, direction: sortConfig.key === key && sortConfig.direction === 'ascending' ? 'descending' : 'ascending' });
            const getSortedMembers = (list) => {
                return [...list].sort((a, b) => {
                    if (sortConfig.key === 'rank' || sortConfig.key === 'ninRole') {
                        const rA = getRoleRank(a), rB = getRoleRank(b);
                        if (rA !== rB) return sortConfig.direction === 'ascending' ? rA - rB : rB - rA;
                        const dA = new Date(a.joinDate||'9999').getTime(), dB = new Date(b.joinDate||'9999').getTime();
                        if (dA !== dB) return dA - dB;
                        return (b.isLeader?1:0) - (a.isLeader?1:0);
                    }
                    if (sortConfig.key === 'activity') {
                        const actA = getActivityStats(a.activityStats).total;
                        const actB = getActivityStats(b.activityStats).total;
                        return sortConfig.direction === 'ascending' ? actA - actB : actB - actA;
                    }
                    let av = a[sortConfig.key], bv = b[sortConfig.key];
                    if (sortConfig.key === 'joinDate') {
                         const dA = new Date(av||'1970'), dB = new Date(bv||'1970');
                         return sortConfig.direction === 'ascending' ? dA - dB : dB - dA;
                    }
                    if (typeof av === 'boolean') { av=av?1:0; bv=bv?1:0; }
                    else if (typeof av === 'string') { av=av.toLowerCase(); bv=bv.toLowerCase(); }
                    if (av == null) av=''; if (bv == null) bv='';
                    return av < bv ? (sortConfig.direction === 'ascending'?-1:1) : (sortConfig.direction === 'ascending'?1:-1);
                });
            };
            const SortIcon = ({k}) => sortConfig.key !== k ? <ArrowUpDown size={14} className="opacity-30 ml-1"/> : (sortConfig.direction === 'ascending' ? <ArrowUp size={14} className="text-cyan-400"/> : <ArrowDown size={14} className="text-cyan-400"/>);
            const formatDate = (dateString) => { if (!dateString) return "-"; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; };

            if (!user) return (
                <div className="min-h-screen bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] flex items-center justify-center p-4 font-mono">
                    <div className="max-w-md w-full bg-slate-800/80 backdrop-blur border border-slate-700 p-8 rounded-2xl text-center shadow-2xl">
                        <Ghost size={48} className="mx-auto text-cyan-400 mb-6" />
                        <h1 className="text-3xl font-bold text-white mb-2 mist-title">Névoa System</h1>
                        <button onClick={handleLogin} className="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-3 rounded mb-4">Entrar com Discord</button>
                        <button onClick={() => setUser({ username: "Admin", id: "demo", roles: [] })} className="w-full bg-slate-700 text-slate-300 py-2 rounded text-sm">Modo Demo</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] text-slate-200 font-mono">
                    {/* ... (Todo o JSX do App.jsx original, já incluso aqui) ... */}
                    {/* Para economizar espaço, vou replicar a estrutura principal, mas confie que toda a lógica de renderização está presente */}
                    
                    {/* Modal Config */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="flex border-b border-slate-700">
                                    <button onClick={() => setSettingsTab('roles')} className={`flex-1 p-4 font-bold text-sm ${settingsTab === 'roles' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-slate-800' : 'text-slate-400 hover:text-white bg-slate-900/50'}`}><Settings size={16} className="inline mr-2"/> Cargos</button>
                                    <button onClick={() => setSettingsTab('permissions')} className={`flex-1 p-4 font-bold text-sm ${settingsTab === 'permissions' ? 'text-emerald-400 border-b-2 border-emerald-400 bg-slate-800' : 'text-slate-400 hover:text-white bg-slate-900/50'}`}><ShieldCheck size={16} className="inline mr-2"/> Acesso</button>
                                </div>
                                <div className="p-6 overflow-y-auto scroll-custom">
                                    {settingsTab === 'roles' && (
                                        <div className="space-y-6">
                                            {Object.values(ORG_CONFIG).map(org => (
                                                <div key={org.id} className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                    <h3 className={`text-sm uppercase font-bold ${org.color} mb-3 flex items-center gap-2`}>{React.createElement(org.icon, {size: 16})} {org.name}</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div className="flex flex-col gap-1"><label className="text-xs text-slate-400">Cargo Padrão</label><select className="bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" value={roleConfig[org.id] || ""} onChange={(e) => setRoleConfig({...roleConfig, [org.id]: e.target.value})}><option value="">Selecione...</option>{discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}</select></div>
                                                        <div className="grid grid-cols-2 gap-4"><div className="flex flex-col gap-1"><label className="text-xs text-yellow-400">Líder</label><select className="bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" value={leaderRoleConfig[org.id] || ""} onChange={(e) => setLeaderRoleConfig({...leaderRoleConfig, [org.id]: e.target.value})}><option value="">Selecione...</option>{discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}</select></div><div className="flex flex-col gap-1"><label className="text-xs text-blue-400">Secundário</label><select className="bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" value={secLeaderRoleConfig[org.id] || ""} onChange={(e) => setSecLeaderRoleConfig({...secLeaderRoleConfig, [org.id]: e.target.value})}><option value="">Selecione...</option>{discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}</select></div></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {settingsTab === 'permissions' && (
                                        <div className="space-y-4">
                                            <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                                                <label className="text-sm font-bold text-purple-400 mb-2 flex items-center gap-2"><UserCog size={16}/> Criador</label>
                                                <select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white" value={accessConfig.creatorId || ""} onChange={(e) => setAccessConfig({...accessConfig, creatorId: e.target.value})}><option value="">Selecione...</option>{discordRoster.map(u => <option key={u.id} value={u.id}>{u.displayName||u.username}</option>)}</select>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700"><label className="text-sm font-bold text-red-400 mb-2">Kage</label><select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white" value={accessConfig.kamiRoleId || ""} onChange={(e) => setAccessConfig({...accessConfig, kamiRoleId: e.target.value})}><option value="">Selecione...</option>{discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}</select></div>
                                                <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700"><label className="text-sm font-bold text-orange-400 mb-2">Conselho</label><select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white" value={accessConfig.councilRoleId || ""} onChange={(e) => setAccessConfig({...accessConfig, councilRoleId: e.target.value})}><option value="">Selecione...</option>{discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}</select></div>
                                            </div>
                                            <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700"><label className="text-sm font-bold text-blue-400 mb-2">Moderador</label><select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white" value={accessConfig.moderatorRoleId || ""} onChange={(e) => setAccessConfig({...accessConfig, moderatorRoleId: e.target.value})}><option value="">Selecione...</option>{discordRoles.map(r => <option key={r.id} value={r.id} style={{color: r.color}}>{r.name}</option>)}</select></div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-6 border-t border-slate-700 bg-slate-900/50 flex justify-end gap-3 rounded-b-xl">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-400 hover:text-white">Cancelar</button>
                                    {canManageSettings && <button onClick={handleSaveConfig} className="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-2 rounded font-bold">Salvar</button>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Edição */}
                    {selectedMember && editForm && (
                        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-4xl shadow-2xl animate-fade-in flex flex-col max-h-[95vh]">
                                <div className="p-6 border-b border-slate-700 flex justify-between items-start bg-slate-900/50 rounded-t-xl">
                                    <div><h2 className="text-2xl font-bold text-white flex items-center gap-2">{isCreating ? "Novo Membro" : editForm.name} {editForm.isLeader && <Crown size={20} className="text-yellow-400" />}</h2><p className="text-slate-400 text-sm font-mono">{isCreating ? `Adicionando à ${ORG_CONFIG[selectedMember.org].name}` : `Ninja da ${ORG_CONFIG[selectedMember.org].name}`}</p></div>
                                    <button onClick={() => setSelectedMember(null)} className="text-slate-400 hover:text-white"><X size={24} /></button>
                                </div>
                                <div className="p-6 overflow-y-auto scroll-custom grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        {isCreating && (
                                            <div className="bg-cyan-900/20 p-4 rounded-lg border border-cyan-500/30">
                                                <label className="text-sm font-bold text-cyan-400 mb-2 block">Selecionar Usuário</label>
                                                <div className="relative">
                                                    <input type="text" placeholder="Buscar..." className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-cyan-500 outline-none" value={searchTerm} onChange={(e) => {setSearchTerm(e.target.value); setIsDropdownOpen(true);}} onFocus={() => setIsDropdownOpen(true)} />
                                                    {isDropdownOpen && (
                                                        <>
                                                            <div className="fixed inset-0 z-10" onClick={() => setIsDropdownOpen(false)}></div>
                                                            <div className="absolute z-20 w-full bg-slate-900 border border-slate-600 rounded-b-lg shadow-xl max-h-40 overflow-y-auto mt-1 scroll-custom">
                                                                {filteredRoster.map(u => (
                                                                    <div key={u.id} className="p-2 hover:bg-slate-800 cursor-pointer text-sm text-white" onClick={() => handleSelectUser(u)}>{u.displayName||u.username}</div>
                                                                ))}
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between flex-wrap gap-4">
                                            <div className="flex items-center gap-4"><label className="text-sm font-bold text-cyan-400">Nível:</label><input type="number" min="1" max="60" className="bg-slate-800 border border-slate-600 rounded w-16 p-1 text-center text-white font-bold" value={editForm.level} onChange={(e) => setEditForm({...editForm, level: e.target.value})} /></div>
                                            <div className="flex items-center gap-2"><Calendar size={16} className="text-slate-400"/><input type="date" className="bg-slate-800 border border-slate-600 rounded p-1 text-white text-xs" value={editForm.joinDate || ""} onChange={(e) => setEditForm({...editForm, joinDate: e.target.value})} /></div>
                                            <div className="flex items-center gap-3"><label className="text-sm text-slate-300">Bônus</label><div onClick={() => setEditForm({...editForm, guildBonus: !editForm.guildBonus})} className={`w-12 h-6 rounded-full p-1 cursor-pointer transition-colors ${editForm.guildBonus ? 'bg-cyan-600' : 'bg-slate-700'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${editForm.guildBonus ? 'translate-x-6' : ''}`}></div></div></div>
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                            <div className="flex justify-between items-start mb-4">
                                                <div><h3 className="text-white font-bold flex items-center gap-2"><Activity size={16}/> Atributos</h3>{!isCreating && selectedMember.statsUpdatedAt && (<p className="text-[10px] text-slate-500 mt-1 flex items-center gap-1"><Clock size={10} /> Atualizado: {formatDateTime(selectedMember.statsUpdatedAt)}</p>)}</div>
                                                <span className={`text-xs font-bold px-2 py-1 rounded ${remainingPoints < 0 ? 'bg-red-900/50 text-red-400' : 'bg-slate-800 text-slate-400'}`}>Pts: {remainingPoints}</span>
                                            </div>
                                            <div className="space-y-3">{STATS.map(stat => (<div key={stat} className="flex items-center justify-between"><label className="text-sm text-slate-300 w-24">{stat}</label><div className="flex items-center gap-2"><input type="number" min="5" className="bg-slate-800 border border-slate-600 rounded w-20 p-1 text-center text-cyan-400 font-bold font-mono outline-none focus:border-cyan-500" value={editForm.stats[stat]} onChange={(e) => updateStat(stat, e.target.value)} /></div>{editForm.guildBonus && <span className="text-xs text-emerald-400 font-mono w-8 text-right">({Math.floor(editForm.stats[stat] * 1.1)})</span>}</div>))}</div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4"><div className="bg-red-900/20 border border-red-500/30 p-4 rounded-lg text-center"><Heart className="mx-auto text-red-500 mb-2"/><span className="text-2xl font-bold text-white">{finalVitals.hp}</span><p className="text-xs text-red-400 uppercase mt-1">Vida</p></div><div className="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg text-center"><Zap className="mx-auto text-blue-500 mb-2"/><span className="text-2xl font-bold text-white">{finalVitals.cp}</span><p className="text-xs text-blue-400 uppercase mt-1">Chakra</p></div></div>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                            <h3 className="text-white font-bold mb-3">Cargos</h3>
                                            <div className="mb-4"><label className="text-xs text-slate-400 mb-1 block">Cargo Nin</label><select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none" value={editForm.ninRole} onChange={(e) => setEditForm({...editForm, ninRole: e.target.value})}>{ORG_CONFIG[selectedMember.org].internalRoles.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                                            <div className="mb-4"><label className="text-xs text-slate-400 mb-1 block">Cargo Discord</label><select className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white outline-none text-sm" value={editForm.specificRoleId || ""} onChange={(e) => setEditForm({...editForm, specificRoleId: e.target.value})}><option value="">Padrão</option>{discordRoles.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}</select></div>
                                            <div className="flex items-center gap-3 bg-slate-800 p-3 rounded border border-slate-600"><input type="checkbox" id="leaderCheck" checked={editForm.isLeader} onChange={(e) => setEditForm({...editForm, isLeader: e.target.checked})} className="w-4 h-4 text-cyan-600 rounded bg-gray-700 border-gray-600"/><label htmlFor="leaderCheck" className="text-sm text-white font-bold cursor-pointer select-none flex items-center gap-2"><Crown size={14} className={editForm.isLeader ? "text-yellow-400" : "text-slate-500"}/> Líder?</label></div>
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-700 h-full">
                                            <h3 className="text-white font-bold mb-4">Maestrias</h3>
                                            <div className="grid grid-cols-2 gap-3">{MASTERIES.map(m => {const isActive = editForm.masteries.includes(m.id); return (<div key={m.id} onClick={() => toggleMastery(m.id)} className={`cursor-pointer p-3 rounded border flex items-center gap-3 transition-all ${isActive ? 'bg-slate-700 border-cyan-500/50' : 'bg-slate-800 border-slate-700 hover:bg-slate-700/50'}`}><div className={`${isActive ? 'text-white' : m.color}`}>{React.createElement(Icons[m.icon], {size: 18})}</div><span className={`text-sm ${isActive ? 'text-white font-bold' : 'text-slate-400'}`}>{m.id}</span></div>)})}</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-slate-700 bg-slate-900/50 rounded-b-xl flex justify-between items-center">
                                    <span className="text-xs text-slate-500"></span>
                                    <div className="flex gap-3">
                                        <button onClick={() => setSelectedMember(null)} className="px-6 py-2 text-slate-400 hover:text-white transition-colors">Cancelar</button>
                                        {canManageOrg(selectedMember.org) && <button onClick={handleSaveEdit} className="bg-cyan-600 hover:bg-cyan-500 text-white px-8 py-2 rounded font-bold shadow-lg shadow-cyan-500/20">{isCreating ? "Adicionar" : "Salvar"}</button>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Exclusão */}
                    {deleteConfirmation && (
                        <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-600 rounded-xl p-6 max-w-md w-full shadow-2xl text-center">
                                <AlertTriangle className="mx-auto text-yellow-400 mb-4" size={48} />
                                <h3 className="text-xl font-bold text-white mb-2">Confirmar</h3>
                                <p className="text-slate-400 text-sm mb-6">Tem certeza que deseja excluir?</p>
                                <div className="flex justify-center gap-3"><button onClick={() => setDeleteConfirmation(null)} className="px-4 py-2 text-slate-300">Cancelar</button><button onClick={() => handleRemoveMember(deleteConfirmation)} className="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded font-bold">Excluir</button></div>
                            </div>
                        </div>
                    )}

                    <header className="border-b border-slate-800 bg-slate-900/90 backdrop-blur sticky top-0 z-50">
                        <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3"><div className="p-2 bg-cyan-900/30 rounded border border-cyan-500/30 text-cyan-400"><RefreshCw size={20} className={loading ? 'animate-spin' : ''} /></div><h1 className="text-xl md:text-2xl font-bold mist-title text-cyan-50 tracking-wider">Névoa <span className="text-cyan-500">System</span></h1></div>
                            <div className="flex items-center gap-4">{canManageSettings && <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-cyan-400 transition-colors"><Settings size={20} /></button>}<div className="flex items-center gap-2 px-3 py-1 bg-slate-800 rounded-full border border-slate-700"><div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div><span className="text-xs font-bold text-slate-300 hidden md:inline">{user.username}</span></div><button onClick={() => setUser(null)} className="text-slate-400 hover:text-red-400 transition-colors"><LogOut size={20} /></button></div>
                        </div>
                    </header>

                    <main className="container mx-auto px-6 py-8">
                        {notification && <div className={`fixed bottom-4 right-4 p-4 rounded shadow-lg text-white z-50 animate-bounce-in ${notification.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>{notification.msg}</div>}

                        {activeTab === 'dashboard' ? (
                            <div className="animate-fade-in space-y-8">
                                {multiOrgUsers.length > 0 && (
                                    <div className="bg-yellow-900/20 border border-yellow-600/30 rounded-xl p-6">
                                        <h3 className="text-yellow-400 font-bold flex items-center gap-2 mb-4"><AlertTriangle size={20} /> Conflitos</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{multiOrgUsers.map((u, idx) => (<div key={idx} className="bg-slate-800/50 p-3 rounded border border-yellow-700/20 flex flex-col"><span className="font-bold text-white">{u.name}</span><span className="text-xs text-slate-400 mt-1">Membro de: <span className="text-yellow-200">{u.orgs.join(", ")}</span></span></div>))}</div>
                                    </div>
                                )}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {Object.values(ORG_CONFIG).map((org) => {
                                        const count = members.filter(m => m.org === org.id).length;
                                        const percentage = (count / org.limit) * 100;
                                        return (
                                            <div key={org.id} onClick={() => setActiveTab(org.id)} className={`glass-panel p-6 rounded-xl cursor-pointer hover:scale-105 transition-all hover:shadow-lg hover:shadow-cyan-500/10 ${org.border} border-t-4`}>
                                                <div className="flex justify-between items-start mb-4"><div className={`p-3 rounded-lg ${org.bgColor} ${org.color}`}>{React.createElement(Icons[org.icon], {size: 24})}</div><span className="text-2xl font-bold font-mono">{count}/{org.limit}</span></div>
                                                <h3 className="text-lg font-bold mb-1">{org.name}</h3>
                                                <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden mt-2"><div className={`h-full transition-all duration-500 ${org.color.replace('text', 'bg')}`} style={{ width: `${percentage}%` }}></div></div>
                                                {!roleConfig[org.id] && <p className="text-[10px] text-red-400 mt-2 flex items-center gap-1"><AlertCircle size={10}/> Configurar</p>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-4"><button onClick={() => setActiveTab('dashboard')} className="p-2 hover:bg-slate-700 rounded transition-colors text-white">← Voltar</button><div className={`p-3 rounded-lg ${ORG_CONFIG[activeTab].bgColor} ${ORG_CONFIG[activeTab].color}`}>{React.createElement(Icons[ORG_CONFIG[activeTab].icon])}</div><h2 className="text-3xl font-bold mist-title text-white">{ORG_CONFIG[activeTab].name}</h2></div>
                                    <span className={`text-2xl font-bold ${members.filter(m => m.org === activeTab).length >= ORG_CONFIG[activeTab].limit ? 'text-red-400' : 'text-emerald-400'}`}>{members.filter(m => m.org === activeTab).length} / {ORG_CONFIG[activeTab].limit}</span>
                                </div>
                                {canManageOrg(activeTab) && <div className="mb-6 flex justify-end"><button onClick={openCreateModal} className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg shadow-cyan-500/20 transition-all hover:scale-105"><UserPlus size={20} /> Novo Membro</button></div>}
                                <div className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-800/50 text-slate-400 text-xs uppercase"><tr>
                                            <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('role')}>Discord <SortIcon k="role"/></th>
                                            <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('name')}>Nome <SortIcon k="name"/></th>
                                            <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('ninRole')}>Cargo Nin <SortIcon k="ninRole"/></th>
                                            <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('joinDate')}>Entrada <SortIcon k="joinDate"/></th>
                                            <th className="p-4 cursor-pointer hover:text-white" onClick={() => requestSort('activity')}>Ativ. <SortIcon k="activity"/></th>
                                            <th className="p-4 text-center cursor-pointer hover:text-white" onClick={() => requestSort('isLeader')}>Líder <SortIcon k="isLeader"/></th>
                                            {canManageOrg(activeTab) && <th className="p-4 text-right">Ações</th>}
                                        </tr></thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {getSortedMembers(members.filter(m => m.org === activeTab)).map((member) => {
                                                const leaderRoleId = leaderRoleConfig[member.org];
                                                const leaderRoleName = member.isLeader && leaderRoleId ? discordRoles.find(r => r.id === leaderRoleId)?.name : null;
                                                const orgInfo = getMemberOrgsInfo(member.discordId);
                                                const memberMasteries = member.masteries || [];
                                                const activity = getActivityStats(member.activityStats);
                                                return (
                                                    <tr key={member.id} className={`hover:bg-slate-800/30 transition-colors cursor-pointer ${member.isLeader ? 'bg-yellow-900/10' : ''}`} onClick={() => canManageOrg(activeTab) && openEditModal(member)}>
                                                        <td className="p-4"><div className="flex flex-col gap-1 items-start"><span className={`px-2 py-1 rounded text-xs font-bold border ${ORG_CONFIG[activeTab].border} ${ORG_CONFIG[activeTab].color} bg-opacity-10`}>{member.role}</span>{leaderRoleName && <span className="px-2 py-1 rounded text-xs font-bold border border-yellow-500/50 text-yellow-400 bg-yellow-900/20">{leaderRoleName}</span>}</div></td>
                                                        <td className="p-4"><div className="flex flex-col"><span className="font-bold text-white flex items-center gap-2">{member.name}{orgInfo && (<div className="text-yellow-400 cursor-help" title={`Membro de: ${orgInfo.names}`} onClick={(e) => e.stopPropagation()}><AlertCircle size={14} /></div>)}</span><div className="flex items-center gap-1 mt-1">{memberMasteries.map(m => {const mData = MASTERIES.find(mastery => mastery.id === m); if (!mData) return null; return (<div key={m} title={m} className={`${mData.color}`}>{React.createElement(Icons[mData.icon], {size: 14})}</div>)})}</div></div></td>
                                                        <td className="p-4"><span className="text-slate-300 text-sm">{member.ninRole}</span></td>
                                                        <td className="p-4"><span className="text-slate-300 text-sm font-mono">{formatDate(member.joinDate)}</span></td>
                                                        <td className="p-4"><div className="flex items-center gap-2" title={`Score: ${activity.total}`}><div className={`w-8 h-8 rounded-full flex items-center justify-center text-white ${activity.color} shadow-lg shadow-${activity.color}/50`}>{React.createElement(activity.icon, {size: 18})}</div><div className="flex flex-col w-24"><span className="text-[10px] uppercase font-bold text-slate-400">{activity.tier}</span><div className="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden mt-1"><div className={`h-full ${activity.color}`} style={{ width: activity.width }}></div></div></div></div></td>
                                                        <td className="p-4 text-center">{canManageOrg(activeTab) ? (<button onClick={(e) => { e.stopPropagation(); handleToggleLeader(member); }} className={`p-2 rounded-full transition-all ${member.isLeader ? 'text-yellow-400 bg-yellow-400/10' : 'text-slate-600 hover:text-yellow-400'}`} title="Líder"><Crown size={18} fill={member.isLeader ? "currentColor" : "none"} /></button>) : (member.isLeader && <Crown size={18} className="text-yellow-400 inline-block" fill="currentColor"/>)}</td>
                                                        {canManageOrg(activeTab) && <td className="p-4 text-right" onClick={(e) => e.stopPropagation()}><button onClick={() => setDeleteConfirmation(member.id)} className="text-slate-500 hover:text-red-400 p-2"><Trash2 size={16} /></button></td>}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
